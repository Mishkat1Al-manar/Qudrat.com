<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…Ù†ØµØ© Ø§Ù„Ù‚Ø¯Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠØ©</title>  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020; --bg2:#0e1428; --card:#0e162c; --muted:#9fb0c7;
      --gold:#d4af37; --royal:#1d4ed8; --teal:#06b6d4; --ok:#22c55e; --err:#ef4444; --warn:#f59e0b;
      --glass: rgba(255,255,255,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Tajawal',system-ui,Arial,sans-serif; color:#e6edf5;
      background:
        radial-gradient(1200px 600px at 110% -10%, rgba(29,78,216,.25), transparent 60%),
        radial-gradient(800px 400px at -10% 110%, rgba(212,175,55,.18), transparent 60%),
        linear-gradient(180deg,var(--bg),#081024 80%);
    }
    a{color:var(--teal);text-decoration:none}
    .container{max-width:1200px;margin:auto;padding:24px}
    .brand{
      display:flex;align-items:center;gap:12px;margin-bottom:22px
    }
    .logo{
      width:52px;height:52px;border-radius:14px;background:
       conic-gradient(from 210deg, rgba(212,175,55,.9), rgba(6,182,212,.8), rgba(29,78,216,.85), rgba(212,175,55,.9));
      position:relative; box-shadow:0 8px 30px rgba(0,0,0,.35), inset 0 0 30px rgba(255,255,255,.08);
    }
    .logo:after{content:"â˜…";position:absolute;inset:0;display:grid;place-items:center;font-weight:900;color:rgba(255,255,255,.85)}
    h1{margin:0;font-size:24px;letter-spacing:.3px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:4px}

    /* Auth Split */
    .split{
      display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:stretch
    }
    .panel{
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;padding:20px;position:relative;overflow:hidden
    }
    .panel:before{
      content:"";position:absolute;inset:-2px;pointer-events:none;border-radius:18px;
      background:linear-gradient(120deg,transparent,rgba(212,175,55,.25),transparent 60%);
      mask:linear-gradient(#000,#000) content-box, linear-gradient(#000,#000);
      -webkit-mask-composite: xor; mask-composite: exclude; padding:2px;
    }
    .panel h2{margin:0 0 14px 0;font-size:20px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{
      width:100%;background:rgba(8,14,30,.7);border:1px solid rgba(255,255,255,.12);
      color:#fff;padding:12px;border-radius:12px;outline:none;transition:.2s; font-family:inherit
    }
    input:focus,select:focus,textarea:focus{border-color:var(--teal);box-shadow:0 0 0 3px rgba(6,182,212,.2)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:8px;
      background:linear-gradient(180deg, rgba(212,175,55,.95), rgba(212,175,55,.75));
      color:#1a1f2e;font-weight:800;border:0;padding:12px 14px;border-radius:12px;cursor:pointer;box-shadow:0 8px 24px rgba(212,175,55,.22);
    }
    .btn.secondary{background:linear-gradient(180deg, rgba(6,182,212,.95), rgba(6,182,212,.7)); color:#061020}
    .btn.ghost{background:rgba(255,255,255,.07);color:#fff;border:1px solid rgba(255,255,255,.1)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:12px}
    .hint{font-size:12px;color:#c1d5ff}
    .hidden{display:none !important}
    .tag{background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);padding:6px 10px;border-radius:999px;font-size:12px}

    /* Tabs */
    .tabs{display:flex;gap:8px;margin-bottom:14px}
    .tab{padding:10px 12px;border-radius:10px;cursor:pointer;border:1px solid rgba(255,255,255,.08)}
    .tab.active{background:rgba(212,175,55,.18);border-color:rgba(212,175,55,.45)}

    /* Cards */
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:14px}
    .list{display:grid;gap:10px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .kpi{padding:14px;border-radius:12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08)}
    progress{width:100%;height:10px;border-radius:999px;overflow:hidden}
    progress::-webkit-progress-bar{background:rgba(255,255,255,.1)}
    progress::-webkit-progress-value{background:linear-gradient(90deg,var(--gold),var(--teal))}
    .right{ text-align:right }
    .img-preview{max-width:100%;border-radius:10px;border:1px solid rgba(255,255,255,.1);margin-top:8px}

    /* Tables */
    table{width:100%;border-collapse:separate;border-spacing:0 10px}
    th,td{padding:10px 12px;text-align:right}
    th{color:#c9d6f3;font-weight:700}
    tr{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08)}
    tr td:first-child,tr th:first-child{border-radius:10px 0 0 10px}
    tr td:last-child,tr th:last-child{border-radius:0 10px 10px 0}

    @media (max-width:900px){ .split{grid-template-columns:1fr} .kpis{grid-template-columns:1fr 1fr} }
    @media (max-width:560px){ .kpis{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container" id="app">

    <!-- ====== Brand ====== -->
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>Ù…Ù†ØµÙ‘Ø© Ø§Ù„Ù‚Ø¯Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠØ©</h1>
        <div class="subtitle">Ø«Ø§Ù†ÙˆÙŠØ© Ù…Ø´ÙƒØ§Ø© Ø§Ù„Ù…Ù†Ø§Ø± Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</div>
      </div>
      <div style="margin-inline-start:auto" id="userMini"></div>
    </div>

    <!-- ====== AUTH ====== -->
    <div id="authView">
      <div class="split">
        <!-- Register (left) -->
        <div class="panel">
          <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø·Ø§Ù„Ø¨</h2>
          <div class="grid-2">
            <div>
              <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label>
              <input id="regFullname" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ">
            </div>
            <div>
              <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
              <input id="regUsername" placeholder="username">
            </div>
          </div>
          <div class="grid-2" style="margin-top:10px">
            <div>
              <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
              <input id="regPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <div>
              <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
              <input id="regPassword2" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
          </div>
          <div class="grid-2" style="margin-top:10px">
            <div>
              <label>Ø§Ù„ØµÙ</label>
              <select id="regGrade">
                <option value="">Ø§Ø®ØªØ±</option>
                <option>Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ</option>
                <option>Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ</option>
                <option>Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ</option>
              </select>
            </div>
            <div>
              <label>Ø§Ù„ÙØµÙ„</label>
              <select id="regClass">
                <option value="">Ø§Ø®ØªØ±</option>
                <option>1</option><option>2</option><option>3</option><option>4</option>
              </select>
            </div>
          </div>
          <div class="row" style="margin-top:14px">
            <button class="btn" id="btnRegister">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
          </div>
          <div class="muted" id="regMsg" style="margin-top:8px"></div>
        </div>

        <!-- Login (right) -->
        <div class="panel">
          <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
          <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
          <input id="loginUsername" placeholder="admin Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
          <label style="margin-top:10px">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
          <input id="loginPassword" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          <div class="row" style="margin-top:14px">
            <button class="btn secondary" id="btnLogin">Ø¯Ø®ÙˆÙ„</button>
          </div>
          <div class="muted" id="loginMsg" style="margin-top:8px"></div>
        </div>
      </div>
    </div>

    <!-- ====== STUDENT DASH ====== -->
    <div id="studentView" class="hidden">
      <div class="tabs">
        <div class="tab active" data-stab="home">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
        <div class="tab" data-stab="collections">Ù‚Ø³Ù… Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª</div>
        <div class="tab" data-stab="results">Ù†ØªØ§Ø¦Ø¬ÙŠ</div>
        <div class="tab" data-stab="messages">Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª</div>
        <div class="tab" data-stab="profile">Ø­Ø³Ø§Ø¨ÙŠ</div>
        <div style="margin-inline-start:auto" class="tab" id="logoutS">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
      </div>

      <div id="sHome">
        <div class="kpis">
          <div class="kpi">
            <div class="muted">Ø¹Ø¨Ø§Ø±Ø© ØªØ­ÙÙŠØ²ÙŠØ©</div>
            <div id="motiv" style="font-weight:900;font-size:18px;line-height:1.6;margin-top:6px"></div>
          </div>
          <div class="kpi">
            <div class="muted">Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚Ø¯Ù…</div>
            <div style="font-size:28px;font-weight:900" id="progressPct">0%</div>
            <progress id="progressBar" value="0" max="100"></progress>
          </div>
          <div class="kpi">
            <div class="muted">Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© (Ø£Ø¹Ù„Ù‰ 5)</div>
            <div id="leaderMini" class="list" style="margin-top:8px"></div>
          </div>
          <div class="kpi">
            <div class="muted">Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</div>
            <div id="studentInfo" style="margin-top:6px"></div>
          </div>
        </div>
      </div>

      <div id="sCollections" class="hidden">
        <div class="row" style="margin-bottom:10px">
          <span class="tag">ÙƒÙ…ÙŠ</span>
          <span class="tag">Ù„ÙØ¸ÙŠ</span>
          <span class="muted">ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø£ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø±Ø§Øª ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯Ø©</span>
        </div>
        <div id="testsList" class="list"></div>
      </div>

      <div id="sResults" class="hidden">
        <div id="myResults"></div>
      </div>

      <div id="sMessages" class="hidden">
        <div class="grid-2">
          <div class="card">
            <h3 style="margin:0 0 8px 0">Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h3>
            <label>Ø±Ø³Ø§Ù„ØªÙƒ</label>
            <textarea id="msgText" rows="4" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„..."></textarea>
            <button class="btn" id="sendMsg" style="margin-top:10px">Ø¥Ø±Ø³Ø§Ù„</button>
            <div class="muted" id="msgSendInfo" style="margin-top:6px"></div>
          </div>
          <div class="card">
            <h3 style="margin:0 0 8px 0">Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h3>
            <div id="msgInbox" class="list"></div>
          </div>
        </div>
      </div>

      <div id="sProfile" class="hidden">
        <div class="card">
          <h3 style="margin:0 0 8px 0">ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3>
          <div class="grid-2">
            <div>
              <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
              <input id="newPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <div>
              <label>ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
              <input id="newPass2" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
          </div>
          <button class="btn" id="savePass" style="margin-top:10px">Ø­ÙØ¸</button>
          <div class="muted" id="passMsg" style="margin-top:6px"></div>
        </div>
      </div>
    </div>

    <!-- ====== ADMIN DASH ====== -->
    <div id="adminView" class="hidden">
      <div class="tabs">
        <div class="tab active" data-atab="students">Ø§Ù„Ø·Ù„Ø§Ø¨</div>
        <div class="tab" data-atab="builder">Ø¥Ù†Ø´Ø§Ø¡ ØªØ¬Ù…ÙŠØ¹Ø§Øª/Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</div>
        <div class="tab" data-atab="results">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</div>
        <div class="tab" data-atab="inbox">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</div>
        <div style="margin-inline-start:auto" class="tab" id="logoutA">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</div>
      </div>

      <div id="aStudents">
        <div class="card">
          <h3 style="margin:0 0 10px 0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h3>
          <div id="studentsTable"></div>
        </div>
      </div>

      <div id="aBuilder" class="hidden">
        <div class="card">
          <h3 style="margin:0 0 8px 0">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
          <div class="grid-2">
            <div>
              <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
              <input id="tTitle" placeholder="ØªØ¬Ù…ÙŠØ¹ ÙƒÙ…ÙŠ 1">
            </div>
            <div>
              <label>Ø§Ù„Ù‚Ø³Ù…</label>
              <select id="tSection">
                <option>ÙƒÙ…ÙŠ</option>
                <option>Ù„ÙØ¸ÙŠ</option>
              </select>
            </div>
          </div>

          <h3 style="margin:16px 0 8px 0">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</h3>
          <div class="grid-2">
            <div>
              <label>Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„</label>
              <textarea id="qText" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§..."></textarea>
              <label style="margin-top:8px">ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input type="file" id="qImg" accept="image/*">
              <img id="qImgPreview" class="img-preview hidden">
            </div>
            <div>
              <label>Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª</label>
              <div class="list">
                <input class="opt" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 1">
                <input class="opt" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 2">
                <input class="opt" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 3">
                <input class="opt" placeholder="Ø§Ù„Ø®ÙŠØ§Ø± 4">
              </div>
              <label style="margin-top:8px">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (Ø±Ù‚Ù… 1-4)</label>
              <input id="qCorrect" type="number" min="1" max="4" value="1" style="max-width:120px">
              <div class="row" style="margin-top:10px">
                <button class="btn" id="addQ">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø³Ø¤Ø§Ù„ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
                <button class="btn ghost" id="clearQ">Ù…Ø³Ø­</button>
              </div>
            </div>
          </div>

          <div class="card" style="margin-top:12px">
            <div class="row" style="justify-content:space-between">
              <strong>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</strong>
              <button class="btn secondary" id="saveTest">Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
            </div>
            <div id="qsPreview" class="list" style="margin-top:8px"></div>
          </div>
        </div>
      </div>

      <div id="aResults" class="hidden">
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <h3 style="margin:0">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
            <button class="btn" id="exportCSV">ØªØµØ¯ÙŠØ± CSV</button>
          </div>
          <div id="adminResults"></div>
        </div>
      </div>

      <div id="aInbox" class="hidden">
        <div class="card">
          <h3 style="margin:0 0 8px 0">Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
          <div id="adminInbox" class="list"></div>
        </div>
      </div>
    </div>

    <!-- ====== TEST MODAL ====== -->
    <div id="testModal" class="hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.7);display:grid;place-items:center;z-index:9999">
      <div class="panel" style="max-width:900px;width:min(900px,92vw)">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 id="tmTitle" style="margin:0"></h3>
          <span class="tag" id="tmTimer">40</span>
        </div>
        <div id="tmBody" style="margin-top:8px"></div>
        <div class="row" style="margin-top:12px;justify-content:space-between">
          <button class="btn ghost" id="prevQ">Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
          <div class="row">
            <button class="btn secondary" id="nextQ">Ø§Ù„ØªØ§Ù„ÙŠ</button>
            <button class="btn" id="finishTest">Ø¥Ù†Ù‡Ø§Ø¡</button>
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    // ===== Utilities & Storage =====
    const $ = s=>document.querySelector(s);
    const el = (tag,props={},children=[])=>{
      const e=document.createElement(tag);
      Object.assign(e,props);
      children.forEach(c=>e.appendChild(typeof c==='string'?document.createTextNode(c):c));
      return e;
    };

    const DB = {
      read(k, def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } },
      write(k,v){ localStorage.setItem(k, JSON.stringify(v)) }
    };

    // Seed admin user if not exists
    (function seed(){
      const users = DB.read('users', []);
      if(!users.find(u=>u.role==='admin')){
        users.push({id:'admin', username:'admin', password:'admin', role:'admin', fullname:'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…'});
        DB.write('users', users);
      }
      if(!DB.read('tests', null)){
        DB.write('tests', []); // {id,title,section,questions:[{text,img,options[],correct}], createdAt}
      }
      if(!DB.read('results', null)){ DB.write('results', []) } // {testId, username, score, total, at}
      if(!DB.read('messages', null)){ DB.write('messages', []) } // {id,from,to,text,reply,at}
    })();

    let currentUser = null;

    const motivs = [
      "Ø£Ù†Øª Ù‚Ø¯Ù‡Ø§ â€” Ø®Ø·ÙˆØ© Ø§Ù„ÙŠÙˆÙ… ØªØµÙ†Ø¹ ÙØ±Ù‚ Ø§Ù„ØºØ¯.",
      "Ø±ÙƒÙ‘Ø²ØŒ ØªÙ†ÙÙ‘Ø³ØŒ ÙˆØ§Ø¨Ø¯Ø£. Ø§Ù„Ù‚Ù…Ø© Ø¨Ø§Ù†ØªØ¸Ø§Ø±Ùƒ.",
      "ÙƒÙ„ Ø³Ø¤Ø§Ù„ ÙØ±ØµØ©ØŒ ÙˆÙƒÙ„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ù†Ø¬Ø§Ø².",
      "Ù†ØªØ¹Ø¨ Ø§Ù„ÙŠÙˆÙ…â€¦ Ù†Ù†Ø¨Ø³Ø· Ø¨Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨ÙƒØ±Ø©.",
      "Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø© Ø¯Ø§Ø®Ù„Ùƒ â€” Ø®Ù„Ù‘Ù‡Ø§ ØªØ´ØªØºÙ„!"
    ];

    // ===== AUTH =====
    $('#btnRegister').onclick = ()=>{
      const fullname = $('#regFullname').value.trim();
      const username = $('#regUsername').value.trim();
      const p1 = $('#regPassword').value, p2 = $('#regPassword2').value;
      const grade = $('#regGrade').value, klass = $('#regClass').value;

      if(!fullname || !username || !p1){ return $('#regMsg').textContent="ÙØ¶Ù„Ø§Ù‹ Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©"; }
      if(p1!==p2){ return $('#regMsg').textContent="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚"; }

      const users = DB.read('users', []);
      if(users.find(u=>u.username===username)){ return $('#regMsg').textContent="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³ØªØ®Ø¯Ù… Ø³Ø§Ø¨Ù‚Ø§Ù‹"; }

      users.push({ id:crypto.randomUUID(), fullname, username, password:p1, role:'student', grade, class:klass, progress:0 });
      DB.write('users', users);
      $('#regMsg').textContent = "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨! Ø§Ù„Ø¢Ù† Ø³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† âœ¨";
      $('#regFullname').value = $('#regUsername').value = $('#regPassword').value = $('#regPassword2').value = "";
      $('#regGrade').value = $('#regClass').value = "";
    };

    $('#btnLogin').onclick = ()=>{
      const u = $('#loginUsername').value.trim();
      const p = $('#loginPassword').value;
      const users = DB.read('users', []);
      const user = users.find(x=>x.username===u && x.password===p);
      if(!user){ $('#loginMsg').textContent="Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©"; return; }
      currentUser = user;
      $('#loginMsg').textContent="";
      route();
    };

    const logout = ()=>{ currentUser=null; route(); }

    // ===== ROUTER =====
    function route(){
      $('#authView').classList.add('hidden');
      $('#studentView').classList.add('hidden');
      $('#adminView').classList.add('hidden');
      $('#userMini').innerHTML = "";

      if(!currentUser){
        $('#authView').classList.remove('hidden');
        return;
      }
      $('#userMini').innerHTML = `<span class="tag">Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.fullname||currentUser.username}</span>`;
      if(currentUser.role==='student'){ $('#studentView').classList.remove('hidden'); showStudent(); }
      if(currentUser.role==='admin'){ $('#adminView').classList.remove('hidden'); showAdmin(); }
    }

    // ===== STUDENT =====
    // Tabs
    document.querySelectorAll('#studentView .tab[data-stab]').forEach(t=>{
      t.onclick = ()=>{
        document.querySelectorAll('#studentView .tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const id = t.dataset.stab;
        ['sHome','sCollections','sResults','sMessages','sProfile'].forEach(x=>$('#'+x).classList.add('hidden'));
        if(id==='home') $('#sHome').classList.remove('hidden');
        if(id==='collections') { $('#sCollections').classList.remove('hidden'); renderTestsForStudent(); }
        if(id==='results') { $('#sResults').classList.remove('hidden'); renderMyResults(); }
        if(id==='messages') { $('#sMessages').classList.remove('hidden'); renderStudentInbox(); }
        if(id==='profile') $('#sProfile').classList.remove('hidden');
      }
    });
    $('#logoutS').onclick = logout;

    function showStudent(){
      // Motivation
      $('#motiv').textContent = motivs[Math.floor(Math.random()*motivs.length)];
      // Progress
      const results = DB.read('results', []).filter(r=>r.username===currentUser.username);
      const pct = results.length ? Math.round(100 * results.reduce((a,x)=>a+(x.score/x.total),0) / results.length) : 0;
      $('#progressPct').textContent = pct+"%";
      $('#progressBar').value = pct;
      // Leaderboard
      renderLeaderMini();
      // Info
      $('#studentInfo').innerHTML = `
        <div>Ø§Ù„Ø§Ø³Ù…: <strong>${currentUser.fullname||'-'}</strong></div>
        <div>Ø§Ù„ØµÙ: <strong>${currentUser.grade||'-'}</strong> â€” Ø§Ù„ÙØµÙ„: <strong>${currentUser.class||'-'}</strong></div>
        <div>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <strong>${currentUser.username}</strong></div>
      `;
      // Default tab
      document.querySelectorAll('#studentView .tab').forEach(x=>x.classList.remove('active'));
      document.querySelector('#studentView .tab[data-stab="home"]').classList.add('active');
      ['sHome','sCollections','sResults','sMessages','sProfile'].forEach(x=>$('#'+x).classList.add('hidden'));
      $('#sHome').classList.remove('hidden');
    }

    function renderLeaderMini(){
      const results = DB.read('results', []);
      // Compute best average per user
      const byUser = {};
      results.forEach(r=>{
        byUser[r.username] ??= {sum:0, n:0};
        byUser[r.username].sum += r.score/r.total;
        byUser[r.username].n++;
      });
      const users = DB.read('users', []);
      const rows = Object.entries(byUser).map(([u,v])=>{
        const name = users.find(x=>x.username===u)?.fullname || u;
        const avg = v.n ? Math.round(100*(v.sum/v.n)) : 0;
        return {u,name,avg};
      }).sort((a,b)=>b.avg-a.avg).slice(0,5);
      $('#leaderMini').innerHTML = rows.length? rows.map(r=>`<div>ğŸ† <strong>${r.name}</strong> â€” ${r.avg}%</div>`).join("") : '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯</div>';
    }

    function renderTestsForStudent(){
      const tests = DB.read('tests', []);
      if(!tests.length){ $('#testsList').innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>'; return; }
      const myResults = DB.read('results', []).filter(r=>r.username===currentUser.username);
      $('#testsList').innerHTML = tests.map(t=>{
        const attempts = myResults.filter(r=>r.testId===t.id);
        const last = attempts.at(-1);
        const badge = last ? `<span class="tag">Ø¢Ø®Ø± Ù†ØªÙŠØ¬Ø©: ${last.score}/${last.total}</span>` : `<span class="tag">Ø¬Ø¯ÙŠØ¯</span>`;
        return `
          <div class="card">
            <div class="row" style="justify-content:space-between;align-items:center">
              <div>
                <div><strong>${t.title}</strong> â€” <span class="muted">${t.section}</span></div>
                <div class="row" style="margin-top:6px;gap:8px">${badge} <span class="tag">Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª: ${attempts.length}</span></div>
              </div>
              <button class="btn" onclick="startTest('${t.id}')">Ø¨Ø¯Ø¡/Ø¥Ø¹Ø§Ø¯Ø©</button>
            </div>
          </div>
        `;
      }).join("");
    }

    function renderMyResults(){
      const rows = DB.read('results', []).filter(r=>r.username===currentUser.username);
      if(!rows.length){ $('#myResults').innerHTML='<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯</div>'; return; }
      const tests = DB.read('tests', []);
      let html = `<table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th></tr></thead><tbody>`;
      rows.slice().reverse().forEach(r=>{
        const t = tests.find(x=>x.id===r.testId);
        html += `<tr><td>${new Date(r.at).toLocaleString('ar-SA')}</td><td>${t?.title||'-'}</td><td><strong>${r.score}</strong> / ${r.total}</td></tr>`;
      });
      html += `</tbody></table>`;
      $('#myResults').innerHTML = html;
    }

    // Messages (student)
    $('#sendMsg').onclick = ()=>{
      const txt = $('#msgText').value.trim();
      if(!txt){ $('#msgSendInfo').textContent="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹"; return; }
      const msgs = DB.read('messages', []);
      msgs.push({id:crypto.randomUUID(), from:currentUser.username, to:'admin', text:txt, reply:null, at:Date.now()});
      DB.write('messages', msgs);
      $('#msgText').value="";
      $('#msgSendInfo').textContent="ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ğŸ‘Œ";
      renderStudentInbox();
    };
    function renderStudentInbox(){
      const msgs = DB.read('messages', []).filter(m=>m.from===currentUser.username);
      $('#msgInbox').innerHTML = msgs.length? msgs.slice().reverse().map(m=>`
        <div class="card">
          <div class="muted">${new Date(m.at).toLocaleString('ar-SA')}</div>
          <div style="margin-top:6px">${m.text}</div>
          ${m.reply? `<div class="tag" style="margin-top:8px">Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: ${m.reply}</div>`:''}
        </div>
      `).join("") : '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„</div>';
    }

    // Profile (student)
    $('#savePass').onclick = ()=>{
      const p1 = $('#newPass').value, p2 = $('#newPass2').value;
      if(!p1){ $('#passMsg').textContent="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ±"; return; }
      if(p1!==p2){ $('#passMsg').textContent="ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚"; return; }
      const users = DB.read('users', []);
      const me = users.find(u=>u.username===currentUser.username);
      me.password = p1;
      DB.write('users', users);
      $('#passMsg').textContent="ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« âœ”";
      $('#newPass').value = $('#newPass2').value = "";
    };

    // ===== ADMIN =====
    document.querySelectorAll('#adminView .tab[data-atab]').forEach(t=>{
      t.onclick = ()=>{
        document.querySelectorAll('#adminView .tab').forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const id = t.dataset.atab;
        ['aStudents','aBuilder','aResults','aInbox'].forEach(x=>$('#'+x).classList.add('hidden'));
        if(id==='students') { $('#aStudents').classList.remove('hidden'); renderStudents(); }
        if(id==='builder') { $('#aBuilder').classList.remove('hidden'); renderQsPreview(); }
        if(id==='results') { $('#aResults').classList.remove('hidden'); renderAdminResults(); }
        if(id==='inbox')   { $('#aInbox').classList.remove('hidden'); renderAdminInbox(); }
      }
    });
    $('#logoutA').onclick = logout;

    function showAdmin(){
      // default tab
      document.querySelectorAll('#adminView .tab').forEach(x=>x.classList.remove('active'));
      document.querySelector('#adminView .tab[data-atab="students"]').classList.add('active');
      ['aStudents','aBuilder','aResults','aInbox'].forEach(x=>$('#'+x).classList.add('hidden'));
      $('#aStudents').classList.remove('hidden');
      renderStudents();
    }

    function renderStudents(){
      const users = DB.read('users', []).filter(u=>u.role==='student');
      if(!users.length){ $('#studentsTable').innerHTML='<div class="muted">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙˆÙ†</div>'; return; }
      let html = `<table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„ÙØµÙ„</th></tr></thead><tbody>`;
      users.forEach(s=>{
        html += `<tr><td>${s.fullname||'-'}</td><td>${s.username}</td><td>${s.grade||'-'}</td><td>${s.class||'-'}</td></tr>`;
      });
      html += `</tbody></table>`;
      $('#studentsTable').innerHTML = html;
    }

    // Builder
    let buildQs = []; // session list
    $('#qImg').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{ $('#qImgPreview').src = reader.result; $('#qImgPreview').classList.remove('hidden'); };
      reader.readAsDataURL(f);
    });
    $('#clearQ').onclick = ()=>{
      $('#qText').value=""; document.querySelectorAll('.opt').forEach((o,i)=>o.value=""); $('#qCorrect').value=1;
      $('#qImg').value=""; $('#qImgPreview').classList.add('hidden'); $('#qImgPreview').src="";
    };
    $('#addQ').onclick = ()=>{
      const text = $('#qText').value.trim(); if(!text){ alert('Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„'); return; }
      const opts = [...document.querySelectorAll('.opt')].map(o=>o.value).filter(Boolean);
      if(opts.length<2){ alert('Ø£Ø¯Ø®Ù„ Ø®ÙŠØ§Ø±ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
      const correct = parseInt($('#qCorrect').value||'1'); if(correct<1 || correct>opts.length){ alert('Ø±Ù‚Ù… Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© ØºÙŠØ± ØµØ­ÙŠØ­'); return; }
      const img = $('#qImgPreview').src || null;
      buildQs.push({text, options:opts, correct:correct-1, img});
      renderQsPreview();
      $('#clearQ').click();
    };
    function renderQsPreview(){
      $('#qsPreview').innerHTML = buildQs.length? buildQs.map((q,i)=>`
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:center">
            <strong>Ø³${i+1}:</strong>
            <button class="btn ghost" onclick="delBuildQ(${i})">Ø­Ø°Ù</button>
          </div>
          <div style="margin-top:6px">${q.text}</div>
          ${q.img? `<img class="img-preview" src="${q.img}">` : ""}
          <div class="muted" style="margin-top:6px">Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª: ${q.options.map((o,j)=> j===q.correct? `<strong>(${j+1}) ${o}</strong>` : `(${j+1}) ${o}`).join(' â€” ')}</div>
        </div>
      `).join("") : '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯</div>';
    }
    window.delBuildQ = (i)=>{ buildQs.splice(i,1); renderQsPreview(); }

    $('#saveTest').onclick = ()=>{
      const title = $('#tTitle').value.trim(); if(!title){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†'); return; }
      const section = $('#tSection').value;
      if(buildQs.length===0){ alert('Ø£Ø¶Ù Ø³Ø¤Ø§Ù„Ø§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„'); return; }
      const tests = DB.read('tests', []);
      tests.push({ id:crypto.randomUUID(), title, section, questions:buildQs, createdAt:Date.now() });
      DB.write('tests', tests);
      buildQs = []; renderQsPreview();
      $('#tTitle').value="";
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± âœ…');
    };

    // Admin Results
    function renderAdminResults(){
      const results = DB.read('results', []);
      const tests = DB.read('tests', []);
      const users = DB.read('users', []).filter(u=>u.role==='student');
      if(!results.length){ $('#adminResults').innerHTML='<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>'; return; }
      let html = `<table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</th><th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th></tr></thead><tbody>`;
      results.slice().reverse().forEach(r=>{
        const t = tests.find(x=>x.id===r.testId);
        const name = users.find(u=>u.username===r.username)?.fullname || r.username;
        html += `<tr><td>${new Date(r.at).toLocaleString('ar-SA')}</td><td>${name}</td><td>${t?.title||'-'}</td><td><strong>${r.score}</strong> / ${r.total}</td></tr>`;
      });
      html += `</tbody></table>`;
      $('#adminResults').innerHTML = html;
    }

    $('#exportCSV').onclick = ()=>{
      const rows = DB.read('results', []);
      if(!rows.length){ alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬'); return; }
      const tests = DB.read('tests', []);
      const users = DB.read('users', []);
      const header = ['Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…','Ø§Ù„Ø§Ø³Ù…','Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±','Ø§Ù„Ù†ØªÙŠØ¬Ø©','Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹'];
      const csv = [header.join(',')].concat(rows.map(r=>{
        const t = tests.find(x=>x.id===r.testId);
        const u = users.find(x=>x.username===r.username);
        return [
          new Date(r.at).toLocaleString('ar-SA'),
          r.username,
          (u?.fullname||''),
          (t?.title||''),
          r.score, r.total
        ].map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',');
      })).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'results.csv';
      document.body.appendChild(a); a.click(); a.remove();
    };

    // Admin Inbox
    function renderAdminInbox(){
      const msgs = DB.read('messages', []).slice().reverse();
      const users = DB.read('users', []);
      $('#adminInbox').innerHTML = msgs.length? msgs.map(m=>{
        const name = users.find(u=>u.username===m.from)?.fullname || m.from;
        return `
          <div class="card">
            <div class="muted">${new Date(m.at).toLocaleString('ar-SA')} â€” Ù…Ù†: <strong>${name}</strong></div>
            <div style="margin-top:6px">${m.text}</div>
            <div class="row" style="margin-top:8px">
              <input id="reply_${m.id}" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ">
              <button class="btn secondary" onclick="sendReply('${m.id}')">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</button>
              ${m.reply? `<span class="tag">Ø¢Ø®Ø± Ø±Ø¯: ${m.reply}</span>`:''}
            </div>
          </div>
        `;
      }).join("") : '<div class="muted">Ù„Ø§ Ø±Ø³Ø§Ø¦Ù„</div>';
    }
    window.sendReply = (id)=>{
      const inp = document.getElementById('reply_'+id);
      const msgs = DB.read('messages', []);
      const m = msgs.find(x=>x.id===id); if(!m) return;
      const txt = inp.value.trim(); if(!txt) return;
      m.reply = txt; DB.write('messages', msgs);
      renderAdminInbox();
    };

    // ===== TEST RUNNER =====
    let run = { test:null, idx:0, answers:[], timeLeft:40, timer:null };

    window.startTest = (testId)=>{
      run.test = DB.read('tests', []).find(t=>t.id===testId);
      if(!run.test) return;
      run.idx = 0; run.answers = new Array(run.test.questions.length).fill(null);
      openTestModal();
      loadQuestion();
    };

    function openTestModal(){ $('#testModal').classList.remove('hidden'); $('#tmTitle').textContent = run.test.title; }
    function closeTestModal(){ $('#testModal').classList.add('hidden'); stopTimer(); }

    function loadQuestion(){
      stopTimer();
      run.timeLeft = 40;
      tick();
      run.timer = setInterval(tick, 1000);

      const q = run.test.questions[run.idx];
      const body = [];
      body.push(`<div class="muted">Ø§Ù„Ø³Ø¤Ø§Ù„ ${run.idx+1} Ù…Ù† ${run.test.questions.length}</div>`);
      if(q.img) body.push(`<img class="img-preview" src="${q.img}">`);
      body.push(`<div style="margin-top:8px;font-weight:700">${q.text}</div>`);
      body.push(`<div class="list" style="margin-top:8px">`+
        q.options.map((o,i)=>`
          <label style="display:flex;gap:8px;align-items:center">
            <input type="radio" name="ans" value="${i}" ${run.answers[run.idx]===i?'checked':''}>
            ${o}
          </label>
        `).join('') + `</div>`);
      $('#tmBody').innerHTML = body.join('');

      document.querySelectorAll('input[name="ans"]').forEach(r=>{
        r.onchange = ()=>{ run.answers[run.idx] = +r.value; };
      });

      // Buttons availability
      $('#prevQ').disabled = run.idx===0;
      $('#nextQ').disabled = run.idx===run.test.questions.length-1;
    }

    function tick(){
      $('#tmTimer').textContent = run.timeLeft;
      if(run.timeLeft<=0){ // auto-next or finish
        if(run.idx < run.test.questions.length-1){ run.idx++; loadQuestion(); }
        else { finishTest(); }
      }
      run.timeLeft--;
    }
    function stopTimer(){ if(run.timer){ clearInterval(run.timer); run.timer=null; } }

    $('#nextQ').onclick = ()=>{ if(run.idx<run.test.questions.length-1){ run.idx++; loadQuestion(); } };
    $('#prevQ').onclick = ()=>{ if(run.idx>0){ run.idx--; loadQuestion(); } };
    $('#finishTest').onclick = finishTest;

    function finishTest(){
      stopTimer();
      const qs = run.test.questions;
      let score = 0;
      qs.forEach((q,i)=>{ if(run.answers[i]===q.correct) score++; });
      const results = DB.read('results', []);
      results.push({ testId:run.test.id, username:currentUser.username, score, total:qs.length, at:Date.now() });
      DB.write('results', results);
      closeTestModal();
      alert(`Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± â€” Ù†ØªÙŠØ¬ØªÙƒ: ${score} / ${qs.length}`);
      showStudent(); renderTestsForStudent(); renderMyResults();
    }

    // ===== Global initial =====
    // Quick demo data (optional): add a sample test if none
    (function demo(){
      const tests = DB.read('tests', []);
      if(tests.length===0){
        DB.write('tests', [{
          id: crypto.randomUUID(),
          title: "ØªØ¬Ù…ÙŠØ¹ ÙƒÙ…ÙŠ ØªØ¬Ø±ÙŠØ¨ÙŠ",
          section: "ÙƒÙ…ÙŠ",
          createdAt: Date.now(),
          questions: [
            { text:"ÙƒÙ… Ù†Ø§ØªØ¬ 5 + 7 ØŸ", img:null, options:["10","11","12","13"], correct:2 },
            { text:"Ù‚ÙŠÙ…Ø© 9 Ã— 3 ØŸ", img:null, options:["18","27","21","24"], correct:1 }
          ]
        },{
          id: crypto.randomUUID(),
          title: "ØªØ¬Ù…ÙŠØ¹ Ù„ÙØ¸ÙŠ ØªØ¬Ø±ÙŠØ¨ÙŠ",
          section: "Ù„ÙØ¸ÙŠ",
          createdAt: Date.now(),
          questions: [
            { text:"Ù…Ø±Ø§Ø¯Ù ÙƒÙ„Ù…Ø© (ÙˆØ¬Ù„):", img:null, options:["Ø®Ø§Ø¦Ù","Ø³Ø¹ÙŠØ¯","Ù…Ù†Ø¯Ù‡Ø´","Ù…ÙØªØ®Ø±"], correct:0 },
            { text:"Ø¶Ø¯ ÙƒÙ„Ù…Ø© (Ø¬Ù„Ù‘ÙŠ):", img:null, options:["ÙˆØ§Ø¶Ø­","ØºØ§Ù…Ø¶","Ù‚ÙˆÙŠ","Ù‚Ù„ÙŠÙ„"], correct:1 }
          ]
        }]);
      }
    })();

    // Header actions
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') $('#testModal').classList.add('hidden'); });

    // Start
    route();
  </script>
</body>
</html>
