<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ุงููุฏุฑุงุช ุงูุฃุณุทูุฑูุฉ โ ุซุงูููุฉ ูุดูุงุฉ ุงูููุงุฑ ุงูุฃูููุฉ</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1020; --bg2:#0e1428; --card:#0e162c; --muted:#9fb0c7;
      --gold:#d4af37; --royal:#1d4ed8; --teal:#06b6d4; --ok:#22c55e; --err:#ef4444; --warn:#f59e0b;
      --glass: rgba(255,255,255,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Tajawal',system-ui,Arial; color:#e6eefc; background:
        radial-gradient(1000px 600px at 120% -10%, #1d4ed820 0%, transparent 60%),
        radial-gradient(800px 500px at -20% 120%, #06b6d420 0%, transparent 60%),
        linear-gradient(180deg,var(--bg),var(--bg2));
      overflow-x:hidden;
    }
    a{color:var(--teal); text-decoration:none}
    .wrap{max-width:1200px; margin:0 auto; padding:24px}
    .glass{
      background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px; box-shadow:0 10px 35px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    /* ===== ุดุงุดุฉ ุงูุฏุฎูู/ุงูุชุณุฌูู (ูููู/ูุณุงุฑ) ===== */
    .auth-grid{
      display:grid; grid-template-columns:1fr 1fr; gap:20px; align-items:stretch;
      min-height: calc(100vh - 48px);
    }
    .panel{padding:28px}
    .title{font-weight:900; letter-spacing:.3px}
    .subtitle{color:var(--muted)}
    .divider{height:1px;background:rgba(255,255,255,.08); margin:16px 0}
    label{display:block; font-size:14px; margin:8px 0 6px}
    input,select,textarea{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04); color:#e6eefc; outline:none;
    }
    input::placeholder{color:#b8c6dd}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 16px; border-radius:12px; border:1px solid rgba(255,255,255,.12);
      cursor:pointer; transition:.2s ease; font-weight:700
    }
    .btn-primary{background:linear-gradient(90deg,#1d4ed8,#06b6d4); color:white; border:none}
    .btn:hover{transform:translateY(-1px)}
    .hint{font-size:12px; color:var(--muted)}
    .badge{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid rgba(255,255,255,.16)}
    .badge-gold{border-color:#d4af37aa; color:#f4e7b0}
    .flex{display:flex; gap:12px; align-items:center}
    .space{height:12px}
    .hidden{display:none !important}
    .card{padding:18px; border-radius:14px; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08)}
    .grid-3{display:grid; grid-template-columns:repeat(3,1fr); gap:16px}
    .grid-2{display:grid; grid-template-columns:repeat(2,1fr); gap:16px}
    .grid-auto{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:14px}
    .tag{padding:4px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); font-size:12px}
    .kpi{font-size:32px; font-weight:900}
    .progress{height:12px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden}
    .progress > span{display:block; height:100%; background:linear-gradient(90deg,#06b6d4,#1d4ed8)}
    .list{width:100%; border-collapse:collapse}
    .list th,.list td{border-bottom:1px solid rgba(255,255,255,.08); padding:10px; text-align:right}
    .pill{padding:6px 10px; background:rgba(255,255,255,.07); border:1px solid rgba(255,255,255,.13); border-radius:999px; font-size:12px}
    .danger{color:#ffb4b4}
    .success{color:#b9f6c3}
    .center{text-align:center}
    .right{text-align:right}
    .timer{font-weight:900; letter-spacing:1px}
    .img-q{max-width:100%; border-radius:12px; border:1px solid rgba(255,255,255,.12)}
    /* ููุฏุฑ ุฏุงุฎูู */
    .topbar{display:flex; justify-content:space-between; align-items:center; padding:14px 18px; border-radius:14px; background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08)}
    .avatar{width:36px;height:36px;border-radius:50%; background:linear-gradient(45deg,#1d4ed8,#06b6d4)}
    .tabbar{display:flex; gap:8px; flex-wrap:wrap}
    .tab{padding:10px 14px;border-radius:999px; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1); cursor:pointer}
    .tab.active{background:linear-gradient(90deg,#1d4ed8,#06b6d4); color:#fff; border:none}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .foot{opacity:.7; font-size:12px; margin-top:10px}
    @media(max-width:980px){ .auth-grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- ============ ุดุงุดุฉ ุงูุฏุฎูู/ุงูุชุณุฌูู ============ -->
    <section id="auth" class="auth-grid">
      <!-- ูุณุงุฑ: ุฅูุดุงุก ุญุณุงุจ ููุทูุงุจ -->
      <div class="panel glass">
        <div class="badge badge-gold">ุงูุทูุงุจ ููุท</div>
        <h1 class="title" style="margin:8px 0 4px">ุฅูุดุงุก ุญุณุงุจ ุทุงูุจ</h1>
        <div class="subtitle">ุซุงูููุฉ ูุดูุงุฉ ุงูููุงุฑ ุงูุฃูููุฉ โ ููุตูุฉ ุงููุฏุฑุงุช ุงูุฃุณุทูุฑูุฉ</div>
        <div class="divider"></div>
        <div class="row">
          <div>
            <label>ุงูุงุณู ุงูุซูุงุซู</label>
            <input id="rName" placeholder="ูุซุงู: ูุญูุฏ ุนุจุฏุงููู ุงููุญุทุงูู">
          </div>
          <div>
            <label>ุงุณู ุงููุณุชุฎุฏู</label>
            <input id="rUser" placeholder="username">
          </div>
        </div>
        <div class="row">
          <div>
            <label>ุงูุตู</label>
            <select id="rGrade">
              <option value="">โ ุงุฎุชูุงุฑู โ</option>
              <option>ุฃูู ุซุงููู</option>
              <option>ุซุงูู ุซุงููู</option>
              <option>ุซุงูุซ ุซุงููู</option>
            </select>
          </div>
          <div>
            <label>ุงููุตู</label>
            <select id="rClass">
              <option value="">โ ุงุฎุชูุงุฑู โ</option>
              <option>1</option><option>2</option><option>3</option><option>4</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div>
            <label>ูููุฉ ุงููุฑูุฑ</label>
            <input id="rPass" type="password" placeholder="โขโขโขโขโขโขโขโข">
          </div>
          <div>
            <label>ุชุฃููุฏ ูููุฉ ุงููุฑูุฑ</label>
            <input id="rPass2" type="password" placeholder="โขโขโขโขโขโขโขโข">
          </div>
        </div>
        <div class="space"></div>
        <button class="btn btn-primary" id="btnRegister">ุฅูุดุงุก ุงูุญุณุงุจ</button>
        <div id="regMsg" class="foot"></div>
        <div class="foot">ุจุฅูุดุงุฆู ุญุณุงุจูุง ูุฃูุช ุชูุจู ุจุณูุงุณุฉ ุงูุงุณุชุฎุฏุงู.</div>
      </div>

      <!-- ูููู: ุชุณุฌูู ุงูุฏุฎูู -->
      <div class="panel glass">
        <div class="badge">ุชุณุฌูู ุงูุฏุฎูู</div>
        <h1 class="title" style="margin:8px 0 4px">ูุฑุญุจูุง ุจู โจ</h1>
        <div class="subtitle">ุงุฏุฎู ุจุงุณู ุงููุณุชุฎุฏู ููููุฉ ุงููุฑูุฑ (ุงููุณุคูู: <span class="mono">admin / admin</span>)</div>
        <div class="divider"></div>
        <label>ุงุณู ุงููุณุชุฎุฏู</label>
        <input id="lUser" placeholder="username ุฃู admin">
        <label>ูููุฉ ุงููุฑูุฑ</label>
        <input id="lPass" type="password" placeholder="โขโขโขโขโขโขโขโข">
        <div class="space"></div>
        <button class="btn btn-primary" id="btnLogin">ุฏุฎูู</button>
        <div id="loginMsg" class="foot"></div>
        <div class="foot">ูุตูุญุฉ: ูุง ุชุดุงุฑู ูููุฉ ูุฑูุฑู ูุน ุฃู ุฃุญุฏ.</div>
      </div>
    </section>

    <!-- ============ ููุทูุฉ ุงูุชุทุจูู ุจุนุฏ ุงูุฏุฎูู ============ -->
    <section id="app" class="hidden">
      <div class="topbar glass">
        <div class="flex">
          <div class="avatar"></div>
          <div>
            <div id="hiTitle" class="title" style="font-size:18px">ูุฑุญุจูุง</div>
            <div id="hiSub" class="subtitle">ูุชููู ูู ุชุฌุฑุจุฉ ุฃุณุทูุฑูุฉ</div>
          </div>
        </div>
        <div class="flex">
          <div id="roleBadge" class="pill">ุทุงูุจ</div>
          <button class="btn" id="btnLogout">ุชุณุฌูู ุฎุฑูุฌ</button>
        </div>
      </div>

      <!-- ุชุจููุจุงุช ุงูุทุงูุจ -->
      <div id="studentTabs" class="tabbar hidden" style="margin:12px 0">
        <div class="tab active" data-tab="sHome">ุงูุฑุฆูุณูุฉ</div>
        <div class="tab" data-tab="sBank">ุงูุชุฌููุนุงุช</div>
        <div class="tab" data-tab="sResults">ูุชุงุฆุฌู</div>
        <div class="tab" data-tab="sMsgs">ูุฑุงุณูุฉ ุงููุณุคูู</div>
        <div class="tab" data-tab="sProfile">ุญุณุงุจู</div>
      </div>

      <!-- ุชุจููุจุงุช ุงููุณุคูู -->
      <div id="adminTabs" class="tabbar hidden" style="margin:12px 0">
        <div class="tab active" data-tab="aHome">ููุญุฉ ุงูุชุญูู</div>
        <div class="tab" data-tab="aTests">ุฅูุดุงุก ุงูุชุฌููุนุงุช</div>
        <div class="tab" data-tab="aResults">ูุชุงุฆุฌ ุงูุทูุงุจ</div>
        <div class="tab" data-tab="aMsgs">ุงูุฑุณุงุฆู</div>
        <div class="tab" data-tab="aStudents">ุงูุทูุงุจ ุงููุณุฌููู</div>
      </div>

      <!-- ===== ูุญุชูู ุงูุทุงูุจ ===== -->
      <div id="sHome" class="hidden">
        <div class="grid-3">
          <div class="card">
            <div class="badge">ุนุจุงุฑุฉ ุชุญููุฒูุฉ</div>
            <h2 id="motivation" style="margin:8px 0 10px">ุฃูุช ูุงุฏุฑ ุนูู ุชุญููู ุงููุณุชุญูู ๐ช</h2>
            <div class="foot">ุชุชุบููุฑ ุงูุนุจุงุฑุฉ ุนูุฏ ูู ุฏุฎูู.</div>
          </div>
          <div class="card">
            <div class="badge">ูุณุจุฉ ุงูุชูุฏูู</div>
            <div class="kpi"><span id="progressPct">0</span>%</div>
            <div class="progress"><span id="progressBar" style="width:0%"></span></div>
            <div class="foot">ูุชู ุงุญุชุณุงุจูุง ูู ูุชูุณุท ุฃุนูู 5 ูุญุงููุงุช.</div>
          </div>
          <div class="card">
            <div class="badge">ููุญุฉ ุงูุตุฏุงุฑุฉ</div>
            <table class="list" id="leaderboard"></table>
            <div class="foot">ุชูุงูุณ ุดุฑูู ๐ฅ</div>
          </div>
        </div>
        <div class="space"></div>
        <div class="grid-2">
          <div class="card">
            <div class="badge">ุชุฌููุนุงุช ููู</div>
            <div id="quantList" class="grid-auto"></div>
          </div>
          <div class="card">
            <div class="badge">ุชุฌููุนุงุช ููุธู</div>
            <div id="verbList" class="grid-auto"></div>
          </div>
        </div>
      </div>

      <div id="sBank" class="hidden">
        <div class="card">
          <div class="flex" style="justify-content:space-between">
            <div><span class="badge">ูู ุงูุชุฌููุนุงุช</span></div>
            <div class="flex">
              <span class="tag">ููู</span><span class="tag">ููุธู</span>
            </div>
          </div>
          <div id="allBank" class="grid-auto" style="margin-top:12px"></div>
        </div>
      </div>

      <div id="sResults" class="hidden">
        <div class="card">
          <div class="badge">ูุชุงุฆุฌู</div>
          <table class="list" id="myResults">
            <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงุณู ุงูุชุฌููุน</th><th>ุงูุฏุฑุฌุฉ</th><th>ุงููุฏุฉ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="sMsgs" class="hidden">
        <div class="grid-2">
          <div class="card">
            <div class="badge">ูุญุงุฏุซุชู ูุน ุงููุณุคูู</div>
            <div id="sChat" style="height:260px; overflow:auto; padding:6px"></div>
            <div class="space"></div>
            <div class="row">
              <input id="sMsgInput" placeholder="ุงูุชุจ ุฑุณุงูุชู ููุง...">
              <button class="btn btn-primary" id="sSendMsg">ุฅุฑุณุงู</button>
            </div>
          </div>
          <div class="card">
            <div class="badge">ุชูุจูู</div>
            <div class="foot">ููุจูู ุจุนุฏู ูุดุงุฑูุฉ ูุนูููุงุชู ุงูุดุฎุตูุฉ. ุงููุญุงุฏุซุฉ ุชูุญูุธ ูุญูููุง.</div>
          </div>
        </div>
      </div>

      <div id="sProfile" class="hidden">
        <div class="card">
          <div class="badge">ุชุนุฏูู ุงูููู ุงูุดุฎุตู</div>
          <div class="space"></div>
          <div class="row">
            <div>
              <label>ุงุณู ุงููุณุชุฎุฏู</label>
              <input id="pUser" disabled>
              <div class="hint">ูุง ูููู ุชุนุฏูู ุงุณู ุงููุณุชุฎุฏู</div>
            </div>
            <div>
              <label>ูููุฉ ุงููุฑูุฑ ุงูุฌุฏูุฏุฉ</label>
              <input id="pPass" type="password" placeholder="ุงุชุฑูู ูุงุฑุบูุง ุฅู ูู ุชุฑุบุจ ุจุงูุชุบููุฑ">
            </div>
          </div>
          <div class="space"></div>
          <button class="btn btn-primary" id="btnSaveProfile">ุญูุธ ุงูุชุนุฏูู</button>
          <div id="pMsg" class="foot"></div>
        </div>
      </div>

      <!-- ูุงุฌูุฉ ุญู ุงูุงุฎุชุจุงุฑ ููุทุงูุจ -->
      <div id="takeView" class="hidden">
        <div class="card">
          <div class="flex" style="justify-content:space-between; align-items:center">
            <div>
              <div class="badge" id="tType">ุชุฌููุน</div>
              <h2 id="tTitle" class="title" style="margin:6px 0">โ</h2>
            </div>
            <div class="flex">
              <div class="pill">ุงูุณุคุงู <span id="tIdx">1</span>/<span id="tTotal">1</span></div>
              <div class="pill timer" id="tTimer">40s</div>
              <button class="btn" id="tExit">ุฅููุงุก</button>
            </div>
          </div>
          <div class="divider"></div>

          <div id="qArea">
            <div id="qText" style="font-size:18px; font-weight:700; margin:6px 0 10px">โ</div>
            <img id="qImg" class="img-q hidden" alt="">
            <div id="opts" style="margin-top:12px"></div>
          </div>

          <div class="space"></div>
          <div class="flex" style="justify-content:space-between">
            <button class="btn" id="prevQ">ุงูุณุงุจู</button>
            <button class="btn btn-primary" id="nextQ">ุงูุชุงูู</button>
          </div>
        </div>
      </div>

      <!-- ===== ูุญุชูู ุงููุณุคูู ===== -->
      <div id="aHome" class="hidden">
        <div class="grid-3">
          <div class="card">
            <div class="badge">ุฅุฌูุงูู ุงูุทูุงุจ</div>
            <div class="kpi" id="kStudents">0</div>
          </div>
          <div class="card">
            <div class="badge">ุฅุฌูุงูู ุงูุชุฌููุนุงุช</div>
            <div class="kpi" id="kTests">0</div>
          </div>
          <div class="card">
            <div class="badge">ุฅุฌูุงูู ุงููุญุงููุงุช</div>
            <div class="kpi" id="kSubs">0</div>
          </div>
        </div>
      </div>

      <div id="aTests" class="hidden">
        <div class="grid-2">
          <!-- ุฅูุดุงุก ุชุฌููุน -->
          <div class="card">
            <div class="badge">ุฅูุดุงุก ุชุฌููุน ุฌุฏูุฏ</div>
            <div class="row" style="margin-top:10px">
              <input id="newTitle" placeholder="ุงุณู ุงูุชุฌููุน (ูุซุงู: ููู 10 ุฃุณุฆูุฉ)">
              <select id="newType">
                <option value="quant">ููู</option>
                <option value="verb">ููุธู</option>
              </select>
            </div>
            <div class="space"></div>
            <div id="qBuilder"></div>
            <div class="space"></div>
            <div class="flex">
              <button class="btn" id="addQ">ุฅุถุงูุฉ ุณุคุงู</button>
              <button class="btn btn-primary" id="saveTest">ุญูุธ ุงูุชุฌููุน</button>
            </div>
            <div class="foot">ููู ุณุคุงู ุตูุฑุฉ (ุงุฎุชูุงุฑู) + 4 ุฎูุงุฑุงุช + ุชุญุฏูุฏ ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ.</div>
          </div>

          <!-- ูุงุฆูุฉ ุงูุชุฌููุนุงุช -->
          <div class="card">
            <div class="badge">ุงูุชุฌููุนุงุช ุงูููุฌูุฏุฉ</div>
            <div id="testsList" class="grid-auto" style="margin-top:10px"></div>
          </div>
        </div>
      </div>

      <div id="aResults" class="hidden">
        <div class="card">
          <div class="badge">ูุชุงุฆุฌ ุงูุทูุงุจ ููู ุงุฎุชุจุงุฑ</div>
          <div class="row" style="margin-top:10px">
            <select id="selTest"></select>
            <button class="btn" id="btnExport">ุชุตุฏูุฑ CSV (Excel)</button>
          </div>
          <div class="space"></div>
          <table class="list" id="resTable">
            <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุงูุทุงูุจ</th><th>ุงุณู ุงููุณุชุฎุฏู</th><th>ุงูุฏุฑุฌุฉ</th><th>ุงููุฏุฉ</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="aMsgs" class="hidden">
        <div class="grid-2">
          <div class="card">
            <div class="badge">ูุงุฆูุฉ ุงููุญุงุฏุซุงุช</div>
            <div id="threads" style="max-height:280px; overflow:auto"></div>
          </div>
          <div class="card">
            <div class="badge">ุงููุญุงุฏุซุฉ</div>
            <div id="aChat" style="height:240px; overflow:auto; padding:6px"></div>
            <div class="space"></div>
            <div class="row">
              <input id="aMsgInput" placeholder="ุฑุฏ ุงููุณุคูู...">
              <button class="btn btn-primary" id="aSendMsg">ุฅุฑุณุงู</button>
            </div>
          </div>
        </div>
      </div>

      <div id="aStudents" class="hidden">
        <div class="card">
          <div class="badge">ุงูุทูุงุจ ุงููุณุฌููู</div>
          <table class="list" id="stuTable">
            <thead><tr><th>ุงูุงุณู</th><th>ุงุณู ุงููุณุชุฎุฏู</th><th>ุงูุตู</th><th>ุงููุตู</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

    </section>
  </div>

  <script>
    // ================== ุฃุฏูุงุช ุชุฎุฒูู ูุญููุฉ ==================
    const DB = {
      get(key, def){ try{ return JSON.parse(localStorage.getItem(key)) ?? def }catch{ return def } },
      set(key, val){ localStorage.setItem(key, JSON.stringify(val)) }
    };
    const uid = ()=> Math.random().toString(36).slice(2,10);

    // ููุงุชูุญ ูุงุนุฏุฉ ุจูุงูุงุช ูุญููุฉ
    const K = {
      users: 'mshkat_users',       // [{id, name, user, pass, grade, klass, role:'student'}]
      tests: 'mshkat_tests',       // [{id, title, type:'quant'|'verb', questions:[{text,img,opts[4],correct(0..3)}]}]
      subs:  'mshkat_submissions', // [{id, testId, user, score, elapsedSec, at}]
      msgs:  'mshkat_messages'     // { username: [{from:'student'|'admin', text, at}] }
    };

    // ุชููุฆุฉ ุฃูููุฉ
    if(!DB.get(K.users)) DB.set(K.users, []);
    if(!DB.get(K.tests)) DB.set(K.tests, []);
    if(!DB.get(K.subs))  DB.set(K.subs,  []);
    if(!DB.get(K.msgs))  DB.set(K.msgs,  {});

    // ================== ุนูุงุตุฑ ูุณุงุนุฏุฉ ==================
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    // ุนุจุงุฑุงุช ุชุญููุฒูุฉ
    const MOT = [
      "ุฅุตุฑุงุฑู ุงูููู ูุณุงูู ูุฌุงุญู ุบุฏูุง โจ",
      "ุฎุทูุฉ ุตุบูุฑุฉ ูู ููู ุชุตูุน ูุงุฑููุง ูุจูุฑูุง ๐ช",
      "ุฑููุฒุ ูุซูู ุจููุณูุ ูุงูุจุงูู ุณูุชุจุน ๐",
      "ุนููู ุฃููู ููุง ุชุชุฎูู โ ุงูุทูู! ๐",
      "ูู ูุญุงููุฉ ุชูุฑูุจู ูู ุงูุฏุฑุฌุฉ ุงููุงููุฉ ๐ฅ"
    ];

    // ุงููุณุชุฎุฏู ุงูุญุงูู
    let currentUser = null;

    // ================== ุชุณุฌูู ุญุณุงุจ ==================
    $('#btnRegister').onclick = () => {
      const name = $('#rName').value.trim();
      const user = $('#rUser').value.trim();
      const pass = $('#rPass').value;
      const pass2= $('#rPass2').value;
      const grade= $('#rGrade').value.trim();
      const klass= $('#rClass').value.trim();

      if(!name || !user || !pass){ $('#regMsg').textContent = "ุงูุฑุฌุงุก ุชุนุจุฆุฉ ุงูุญููู ุงูุฃุณุงุณูุฉ."; return; }
      if(pass!==pass2){ $('#regMsg').textContent = "ูููุชุง ุงููุฑูุฑ ุบูุฑ ูุชุทุงุจูุชูู."; return; }

      const users = DB.get(K.users, []);
      if(users.some(u=>u.user===user)){ $('#regMsg').textContent = "ุงุณู ุงููุณุชุฎุฏู ูุณุชุฎุฏู ูุณุจููุง."; return; }

      users.push({id:uid(), name, user, pass, grade, klass, role:'student'});
      DB.set(K.users, users);
      $('#regMsg').textContent = "ุชู ุฅูุดุงุก ุงูุญุณุงุจ ุจูุฌุงุญ! ููููู ุงูุขู ุชุณุฌูู ุงูุฏุฎูู.";
      $('#rName').value = $('#rUser').value = $('#rPass').value = $('#rPass2').value = "";
      $('#rGrade').value = $('#rClass').value = "";
      refreshAdminKpis();
    };

    // ================== ุฏุฎูู ==================
    $('#btnLogin').onclick = () => {
      const user = $('#lUser').value.trim();
      const pass = $('#lPass').value;

      if(user==='admin' && pass==='admin'){
        currentUser = {user:'admin', role:'admin', name:'ุงููุณุคูู'};
        enterApp();
        return;
      }
      const users = DB.get(K.users, []);
      const found = users.find(u=>u.user===user && u.pass===pass);
      if(!found){ $('#loginMsg').textContent = "ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ."; return; }
      currentUser = found;
      enterApp();
    };

    $('#btnLogout').onclick = ()=>{ currentUser=null; $('#app').classList.add('hidden'); $('#auth').classList.remove('hidden'); };

    // ================== ุฏุฎูู ุงูุชุทุจูู ูุชูุฌูู ุงููุงุฌูุงุช ==================
    function enterApp(){
      $('#auth').classList.add('hidden');
      $('#app').classList.remove('hidden');
      $('#hiTitle').textContent = currentUser.role==='admin' ? "ููุญุฉ ุงููุณุคูู" : `ูุฑุญุจูุง ${currentUser.name.split(' ')[0]}!`;
      $('#hiSub').textContent = currentUser.role==='admin' ? "ุฃุฏุฑ ุงูููุตูุฉ ุจุงุญุชุฑุงู" : "ุงูุทูู ูุญู ุฏุฑุฌุฉ ุฃุณุทูุฑูุฉ ๐ซ";
      $('#roleBadge').textContent = currentUser.role==='admin' ? "ูุณุคูู" : "ุทุงูุจ";

      if(currentUser.role==='admin'){
        $('#adminTabs').classList.remove('hidden'); $('#studentTabs').classList.add('hidden');
        switchTab('aHome');
        refreshAdminKpis();
        renderTestsList();
        fillSelTest();
        renderStudentsTable();
        renderThreads();
      }else{
        $('#studentTabs').classList.remove('hidden'); $('#adminTabs').classList.add('hidden');
        $('#motivation').textContent = MOT[Math.floor(Math.random()*MOT.length)];
        switchTab('sHome');
        renderHomeBlocks();
        renderAllBank();
        renderStudentResults();
        renderSChat();
        $('#pUser').value = currentUser.user;
        $('#pPass').value = '';
      }
    }

    // ุชุจููุจ ุนุงู
    $$('.tab').forEach(t=>{
      t.onclick = ()=> switchTab(t.dataset.tab);
    });
    function switchTab(id){
      // ุฃุฎูู ุงูุฌููุน
      ['sHome','sBank','sResults','sMsgs','sProfile','aHome','aTests','aResults','aMsgs','aStudents','takeView'].forEach(x=>$('#'+x).classList.add('hidden'));
      // ุฃูุบู ุชูุนูู ุงูุชุจููุจุงุช
      $$('.tab').forEach(t=>t.classList.remove('active'));
      // ุฃุธูุฑ ุงููุฎุชุงุฑ
      $('#'+id).classList.remove('hidden');
      // ูุนูู ุงูุชุจููุจ
      $$('.tab').find(t=>t.dataset.tab===id)?.classList.add('active');

      // ุชุญุฏูุซุงุช ุฎุงุตุฉ
      if(id==='sHome') renderHomeBlocks();
      if(id==='sBank') renderAllBank();
      if(id==='sResults') renderStudentResults();
      if(id==='sMsgs') renderSChat();
      if(id==='aHome') refreshAdminKpis();
      if(id==='aTests'){ renderTestsList(); }
      if(id==='aResults'){ fillSelTest(); renderResultsTable(); }
      if(id==='aStudents'){ renderStudentsTable(); }
      if(id==='aMsgs'){ renderThreads(); }
    }

    // ================== ูุงุฌูุฉ ุงูุทุงูุจ ==================
    function tests(){ return DB.get(K.tests, []) }
    function subs(){ return DB.get(K.subs,  []) }

    function renderHomeBlocks(){
      // ุชูุฏูู ุงูุทุงูุจ = ูุชูุณุท ุฃุนูู 5 ุฏุฑุฌุงุช
      const my = subs().filter(s=>s.user===currentUser.user).sort((a,b)=>b.score-a.score).slice(0,5);
      const avg = my.length? Math.round(my.reduce((x,s)=>x+s.score,0)/my.length) : 0;
      $('#progressPct').textContent = avg;
      $('#progressBar').style.width = avg+'%';

      // ููุญุฉ ุงูุตุฏุงุฑุฉ โ ุฃูุถู ูุชูุณูุท ุฃุนูู 5 ููู ุทุงูุจ
      const users = DB.get(K.users, []);
      const map = {};
      subs().forEach(s=>{
        map[s.user] = map[s.user] || [];
        map[s.user].push(s.score);
      });
      const rows = users.map(u=>{
        const arr = (map[u.user]||[]).sort((a,b)=>b-a).slice(0,5);
        const av = arr.length? Math.round(arr.reduce((x,y)=>x+y,0)/arr.length) : 0;
        return {name:u.name, user:u.user, avg:av};
      }).sort((a,b)=> b.avg - a.avg).slice(0,10);

      $('#leaderboard').innerHTML = `<tr><th>#</th><th>ุงูุทุงูุจ</th><th>ุงููุชูุณุท</th></tr>`+
        rows.map((r,i)=>`<tr><td>${i+1}</td><td>${r.name}</td><td>${r.avg}</td></tr>`).join('');

      // ุงูุชุฌููุนุงุช
      renderBankTo('quantList','quant');
      renderBankTo('verbList','verb');
    }

    function renderBankTo(elId, type){
      const list = tests().filter(t=>t.type===type);
      $('#'+elId).innerHTML = list.map(t=> testCard(t)).join('') || `<div class="foot">ูุง ุชูุฌุฏ ุชุฌููุนุงุช ุจุนุฏ.</div>`;
      // ุงุฑุจุท ุงูุฃุฒุฑุงุฑ
      list.forEach(t=>{
        $('#start_'+t.id)?.addEventListener('click', ()=> startTest(t.id));
      });
    }
    function renderAllBank(){
      const list = tests();
      $('#allBank').innerHTML = list.map(t=> testCard(t)).join('') || `<div class="foot">ูุง ุชูุฌุฏ ุชุฌููุนุงุช ุจุนุฏ.</div>`;
      list.forEach(t=>{
        $('#start_'+t.id)?.addEventListener('click', ()=> startTest(t.id));
      });
    }
    function testCard(t){
      return `
      <div class="card">
        <div class="flex" style="justify-content:space-between">
          <div>
            <div class="badge">${t.type==='quant'?'ููู':'ููุธู'}</div>
            <div style="font-weight:900;margin-top:6px">${t.title}</div>
          </div>
          <div class="pill">${t.questions.length} ุณุคุงู</div>
        </div>
        <div class="space"></div>
        <button class="btn btn-primary" id="start_${t.id}">ุงุจุฏุฃ ุงูุขู</button>
      </div>`;
    }

    // ูุชุงุฆุฌู
    function renderStudentResults(){
      const my = subs().filter(s=>s.user===currentUser.user).sort((a,b)=> new Date(b.at)-new Date(a.at));
      const tmap = Object.fromEntries(tests().map(t=>[t.id,t]));
      $('#myResults tbody').innerHTML = my.map(s=>`
        <tr>
          <td>${new Date(s.at).toLocaleString('ar-SA')}</td>
          <td>${tmap[s.testId]?.title||'-'}</td>
          <td>${s.score}</td>
          <td>${fmtTime(s.elapsedSec)}</td>
        </tr>`).join('') || `<tr><td colspan="4" class="center">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุจุนุฏ.</td></tr>`;
    }

    // ุฑุณุงุฆู ุงูุทุงูุจ ูุน ุงููุณุคูู
    function renderSChat(){
      const all = DB.get(K.msgs,{});
      const arr = all[currentUser.user]||[];
      $('#sChat').innerHTML = arr.map(m=> bubble(m, m.from==='student')).join('') || `<div class="foot">ุงุจุฏุฃ ูุญุงุฏุซุชู ูุน ุงููุณุคูู.</div>`;
      $('#sChat').scrollTop = 999999;
    }
    $('#sSendMsg').onclick = ()=>{
      const text = $('#sMsgInput').value.trim(); if(!text) return;
      const all = DB.get(K.msgs,{});
      all[currentUser.user] = all[currentUser.user]||[];
      all[currentUser.user].push({from:'student', text, at:new Date().toISOString()});
      DB.set(K.msgs, all);
      $('#sMsgInput').value = '';
      renderSChat(); renderThreads(); // ุญุฏูุซ ุฌุงูุจ ุงููุณุคูู
    };

    // ุชุนุฏูู ูููุฉ ุงููุฑูุฑ
    $('#btnSaveProfile').onclick = ()=>{
      const p = $('#pPass').value;
      if(!p){ $('#pMsg').textContent = "ูู ูุชู ุงูุชุบููุฑ."; return; }
      const users = DB.get(K.users, []);
      const u = users.find(x=>x.user===currentUser.user);
      if(u){ u.pass = p; DB.set(K.users, users); $('#pMsg').textContent = "ุชู ุชุญุฏูุซ ูููุฉ ุงููุฑูุฑ."; $('#pPass').value=''; }
    };

    // ================== ุญู ุงูุงุฎุชุจุงุฑ ููุทุงูุจ ==================
    let take = null; // ุญุงูุฉ ุงูุญู { test, answers[], idx, timer, elapsed }

    function startTest(testId){
      const t = tests().find(x=>x.id===testId);
      if(!t) return alert('ุงูุชุฌููุน ุบูุฑ ููุฌูุฏ.');
      take = { test: JSON.parse(JSON.stringify(t)), answers: Array(t.questions.length).fill(null), idx:0, timer:null, remain:40, elapsed:0, started:Date.now() };
      showQuestion();
      $('#studentTabs').classList.add('hidden'); // ุฅุฎูุงุก ุงูุชุจููุจุงุช ุฃุซูุงุก ุงูุญู
      switchView('takeView');
      runTimer();
    }
    function switchView(id){
      ['sHome','sBank','sResults','sMsgs','sProfile','aHome','aTests','aResults','aMsgs','aStudents','takeView'].forEach(x=>$('#'+x).classList.add('hidden'));
      $('#'+id).classList.remove('hidden');
    }
    function showQuestion(){
      const q = take.test.questions[take.idx];
      $('#tType').textContent = take.test.type==='quant'?'ููู':'ููุธู';
      $('#tTitle').textContent = take.test.title;
      $('#tIdx').textContent = take.idx+1;
      $('#tTotal').textContent = take.test.questions.length;
      $('#tTimer').textContent = take.remain+'s';

      $('#qText').textContent = q.text;
      if(q.img){ $('#qImg').src = q.img; $('#qImg').classList.remove('hidden'); } else { $('#qImg').classList.add('hidden'); }
      // ุงูุฎูุงุฑุงุช
      const chosen = take.answers[take.idx];
      $('#opts').innerHTML = q.opts.map((o,i)=>`
        <label style="display:flex;align-items:center;gap:10px;margin:8px 0">
          <input type="radio" name="opt" ${chosen===i?'checked':''} value="${i}">
          <div>${String.fromCharCode(0x0661+i)}) ${o}</div>
        </label>
      `).join('');
      // ุงูุชุจุฏูู ูุญุฏูุซ ุงูุฅุฌุงุจุฉ
      $$('input[name="opt"]').forEach(r=> r.onchange = ()=> take.answers[take.idx] = +r.value );
    }
    function runTimer(){
      clearInterval(take.timer);
      take.remain = 40; // 40 ุซุงููุฉ ููู ุณุคุงู
      $('#tTimer').textContent = take.remain+'s';
      take.timer = setInterval(()=>{
        take.remain--; take.elapsed++;
        $('#tTimer').textContent = take.remain+'s';
        if(take.remain<=0){ nextQ(); }
      },1000);
    }
    function nextQ(){
      // ุฅุฐุง ุจุงูู ุฃุณุฆูุฉ ุชูุฏูู ูุฅูุง ุฃููู
      if(take.idx < take.test.questions.length-1){
        take.idx++; showQuestion(); runTimer();
      }else{
        finishTest();
      }
    }
    function prevQ(){
      if(take.idx>0){ take.idx--; showQuestion(); runTimer(); }
    }
    $('#nextQ').onclick = nextQ;
    $('#prevQ').onclick = prevQ;
    $('#tExit').onclick = finishTest;

    function finishTest(){
      if(!take) return;
      clearInterval(take.timer);
      // ุงูุญุณุงุจ
      let score = 0;
      take.test.questions.forEach((q,i)=>{ if(take.answers[i]===q.correct) score++; });
      const pct = Math.round(100*score/take.test.questions.length);
      const elapsed = Math.floor((Date.now()-take.started)/1000);
      // ุงุญูุธ ูุญุงููุฉ (ุนุฏุฏ ุบูุฑ ูุญุฏูุฏ)
      const arr = DB.get(K.subs, []);
      arr.push({id:uid(), testId: take.test.id, user: currentUser.user, score: pct, elapsedSec: elapsed, at: new Date().toISOString()});
      DB.set(K.subs, arr);
      take=null;

      alert('ุชู ุฅููุงุก ุงูุงุฎุชุจุงุฑ. ุฏุฑุฌุชู: '+pct);
      // ุงุฑุฌุน ููุทุงูุจ
      $('#studentTabs').classList.remove('hidden');
      switchTab('sResults');
      renderHomeBlocks();
    }

    // ================== ููุญุฉ ุงููุณุคูู ==================
    function refreshAdminKpis(){
      $('#kStudents').textContent = DB.get(K.users, []).length;
      $('#kTests').textContent    = DB.get(K.tests, []).length;
      $('#kSubs').textContent     = DB.get(K.subs,  []).length;
    }

    // ูููุดุฆ ุงูุฃุณุฆูุฉ
    $('#addQ').onclick = ()=>{
      const cont = $('#qBuilder');
      const id = uid();
      const block = document.createElement('div');
      block.className = 'card';
      block.style.marginBottom = '10px';
      block.innerHTML = `
        <div class="badge">ุณุคุงู ุฌุฏูุฏ</div>
        <div class="row" style="margin-top:8px">
          <textarea data-k="text" rows="2" placeholder="ูุต ุงูุณุคุงู"></textarea>
          <input data-k="img" type="file" accept="image/*">
        </div>
        <div class="row" style="margin-top:8px">
          <input data-k="o0" placeholder="ุงูุฎูุงุฑ 1">
          <input data-k="o1" placeholder="ุงูุฎูุงุฑ 2">
        </div>
        <div class="row" style="margin-top:8px">
          <input data-k="o2" placeholder="ุงูุฎูุงุฑ 3">
          <input data-k="o3" placeholder="ุงูุฎูุงุฑ 4">
        </div>
        <div class="row" style="margin-top:8px">
          <select data-k="correct">
            <option value="0">ุงูุตุญูุญ: 1</option>
            <option value="1">ุงูุตุญูุญ: 2</option>
            <option value="2">ุงูุตุญูุญ: 3</option>
            <option value="3">ุงูุตุญูุญ: 4</option>
          </select>
          <button class="btn danger" data-k="del">ุญุฐู ุงูุณุคุงู</button>
        </div>
      `;
      cont.appendChild(block);

      // ุฑูุน ุงูุตูุฑุฉ ุฅูู dataURL
      const up = block.querySelector('[data-k="img"]');
      up.onchange = (e)=>{
        const file = e.target.files[0]; if(!file) return;
        const rdr = new FileReader();
        rdr.onload = ()=>{ up.dataset.dataurl = rdr.result; };
        rdr.readAsDataURL(file);
      };
      // ุญุฐู
      block.querySelector('[data-k="del"]').onclick = ()=> block.remove();
    };

    // ุญูุธ ุงูุชุฌููุน
    $('#saveTest').onclick = ()=>{
      const title = $('#newTitle').value.trim();
      const type  = $('#newType').value;
      if(!title){ alert('ุฃุฏุฎู ุงุณู ุงูุชุฌููุน.'); return; }
      const blocks = Array.from($('#qBuilder').children);
      if(blocks.length===0){ alert('ุฃุถู ุณุคุงููุง ูุงุญุฏูุง ุนูู ุงูุฃูู.'); return; }

      const questions = blocks.map(b=>{
        const text = b.querySelector('[data-k="text"]').value.trim();
        const o0 = b.querySelector('[data-k="o0"]').value.trim();
        const o1 = b.querySelector('[data-k="o1"]').value.trim();
        const o2 = b.querySelector('[data-k="o2"]').value.trim();
        const o3 = b.querySelector('[data-k="o3"]').value.trim();
        const correct = +b.querySelector('[data-k="correct"]').value;
        const img = b.querySelector('[data-k="img"]').dataset.dataurl || '';
        if(!text || !o0 || !o1 || !o2 || !o3) throw new Error('ุฃููู ุฌููุน ุงูุญููู ูู ุงูุฃุณุฆูุฉ.');
        return {text, img, opts:[o0,o1,o2,o3], correct};
      });

      const list = DB.get(K.tests, []);
      list.push({id:uid(), title, type, questions});
      DB.set(K.tests, list);

      $('#newTitle').value=''; $('#qBuilder').innerHTML='';
      alert('ุชู ุญูุธ ุงูุชุฌููุน.');
      renderTestsList(); refreshAdminKpis(); fillSelTest();
    };

    function renderTestsList(){
      const list = DB.get(K.tests, []);
      $('#testsList').innerHTML = list.map(t=>`
        <div class="card">
          <div class="flex" style="justify-content:space-between">
            <div><div class="badge">${t.type==='quant'?'ููู':'ููุธู'}</div><div style="font-weight:900;margin-top:6px">${t.title}</div></div>
            <div class="pill">${t.questions.length} ุณุคุงู</div>
          </div>
          <div class="space"></div>
          <div class="flex">
            <button class="btn" data-act="export" data-id="${t.id}">ุชุตุฏูุฑ CSV ูููุชุงุฆุฌ</button>
            <button class="btn danger" data-act="del" data-id="${t.id}">ุญุฐู</button>
          </div>
        </div>
      `).join('') || `<div class="foot">ูุง ุชูุฌุฏ ุชุฌููุนุงุช ุจุนุฏ.</div>`;
      // ุฑุจุท ุฃุฒุฑุงุฑ
      $('#testsList').querySelectorAll('button').forEach(b=>{
        const act = b.dataset.act, id = b.dataset.id;
        if(act==='del') b.onclick = ()=>{ delTest(id); };
        if(act==='export') b.onclick = ()=>{ exportCSV(id); };
      });
    }
    function delTest(id){
      if(!confirm('ุชุฃููุฏ ุญุฐู ุงูุชุฌููุนุ ุณูุชู ุญุฐู ุฃุณุฆูุชู ููุท (ุงููุญุงููุงุช ุชุจูู ูุญููุธุฉ).')) return;
      const list = DB.get(K.tests, []).filter(t=>t.id!==id);
      DB.set(K.tests, list);
      renderTestsList(); refreshAdminKpis(); fillSelTest();
    }

    // ูุชุงุฆุฌ ุงููุณุคูู
    function fillSelTest(){
      const list = DB.get(K.tests, []);
      $('#selTest').innerHTML = `<option value="">โ ุงุฎุชุฑ ุชุฌููุนูุง โ</option>` +
        list.map(t=>`<option value="${t.id}">${t.title}</option>`).join('');
    }
    $('#selTest').onchange = ()=> renderResultsTable();

    function renderResultsTable(){
      const tid = $('#selTest').value;
      const rows = subs().filter(s=> !tid || s.testId===tid).sort((a,b)=> new Date(b.at)-new Date(a.at));
      const users = Object.fromEntries(DB.get(K.users, []).map(u=>[u.user,u]));
      $('#resTable tbody').innerHTML = rows.map(r=>`
        <tr>
          <td>${new Date(r.at).toLocaleString('ar-SA')}</td>
          <td>${users[r.user]?.name||'-'}</td>
          <td>${r.user}</td>
          <td>${r.score}</td>
          <td>${fmtTime(r.elapsedSec)}</td>
        </tr>`).join('') || `<tr><td class="center" colspan="5">ูุง ุชูุฌุฏ ูุชุงุฆุฌ.</td></tr>`;
    }

    // ุชุตุฏูุฑ CSV
    function exportCSV(testId){
      const rows = subs().filter(s=> !testId || s.testId===testId);
      const users = Object.fromEntries(DB.get(K.users, []).map(u=>[u.user,u]));
      const lines = [['ุงูุชุงุฑูุฎ','ุงูุทุงูุจ','ุงุณู ุงููุณุชุฎุฏู','ุงูุฏุฑุฌุฉ','ุงููุฏุฉ','testId']];
      rows.forEach(r=>{
        lines.push([
          new Date(r.at).toLocaleString('ar-SA'),
          users[r.user]?.name||'',
          r.user,
          r.score,
          fmtTime(r.elapsedSec),
          r.testId
        ]);
      });
      const csv = lines.map(r=> r.map(x=> `"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      download('results.csv', csv, 'text/csv;charset=utf-8;');
    }
    $('#btnExport').onclick = ()=> exportCSV($('#selTest').value || '');

    // ุทูุงุจ ูุณุฌููู
    function renderStudentsTable(){
      const list = DB.get(K.users, []);
      $('#stuTable tbody').innerHTML = list.map(u=>`
        <tr><td>${u.name}</td><td>${u.user}</td><td>${u.grade||'-'}</td><td>${u.klass||'-'}</td></tr>
      `).join('') || `<tr><td colspan="4" class="center">ูุง ููุฌุฏ ุทูุงุจ ุจุนุฏ.</td></tr>`;
    }

    // ุฑุณุงุฆู ุงููุณุคูู
    function renderThreads(){
      const msgs = DB.get(K.msgs,{});
      const users = DB.get(K.users, []);
      const order = Object.keys(msgs).sort((a,b)=>{
        const aAt = msgs[a].slice(-1)[0]?.at || 0;
        const bAt = msgs[b].slice(-1)[0]?.at || 0;
        return new Date(bAt)-new Date(aAt);
      });
      $('#threads').innerHTML = order.map(u=>{
        const name = users.find(x=>x.user===u)?.name || u;
        return `<div class="card" data-thread="${u}" style="cursor:pointer"><div style="font-weight:700">${name}</div><div class="foot mono">@${u}</div></div>`;
      }).join('') || `<div class="foot">ูุง ุชูุฌุฏ ูุญุงุฏุซุงุช.</div>`;

      // ุงูุชุฑุงุถููุง ุงุฎุชุฑ ุฃูู ุฎูุท
      currentThread = currentThread && msgs[currentThread] ? currentThread : order[0]||null;
      renderAChat();
      // ุงุฑุจุท
      $('#threads').querySelectorAll('[data-thread]').forEach(el=>{
        el.onclick = ()=>{ currentThread = el.dataset.thread; renderAChat(); };
      });
    }
    let currentThread = null;
    function renderAChat(){
      const msgs = DB.get(K.msgs,{});
      const arr = msgs[currentThread]||[];
      $('#aChat').innerHTML = currentThread ? arr.map(m=> bubble(m, m.from==='student')).join('') : `<div class="foot">ุงุฎุชุฑ ูุญุงุฏุซุฉ ูู ุงููุณุงุฑ.</div>`;
      $('#aChat').scrollTop = 999999;
    }
    $('#aSendMsg').onclick = ()=>{
      if(!currentThread) return;
      const text = $('#aMsgInput').value.trim(); if(!text) return;
      const all = DB.get(K.msgs,{});
      all[currentThread] = all[currentThread]||[];
      all[currentThread].push({from:'admin', text, at:new Date().toISOString()});
      DB.set(K.msgs, all);
      $('#aMsgInput').value='';
      renderAChat(); renderSChat();
    };

    // ================== ุฃุฏูุงุช ุนุงูุฉ ==================
    function bubble(m, isStudent){
      return `<div style="display:flex;${isStudent?'justify-content:flex-start':'justify-content:flex-end'}">
        <div class="card" style="max-width:70%; ${isStudent?'background:rgba(29,78,216,.18)':'background:rgba(6,182,212,.18)'}">
          <div style="font-size:12px; opacity:.7">${new Date(m.at).toLocaleString('ar-SA')}</div>
          <div>${escapeHtml(m.text)}</div>
        </div>
      </div>`;
    }
    function fmtTime(sec){
      const m = Math.floor(sec/60), s = sec%60;
      return `${m}:${String(s).padStart(2,'0')}`;
    }
    function download(filename, data, mime='text/plain'){
      const blob = new Blob([data], {type:mime});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = filename; a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

    // ุฃุฒุฑุงุฑ ููุญุฉ ุงูุญู
    document.addEventListener('keydown', (e)=>{
      if(!$('#takeView').classList.contains('hidden')){
        if(e.key==='ArrowRight') nextQ();
        if(e.key==='ArrowLeft') prevQ();
      }
    });

    // ุนูุฏ ุงูุชุญููู ุฅู ููุฌุฏ ุฌูุณุฉ ูุฏููุฉ ููููู ูุงุญููุง ุงุณุชุนุงุฏุชูุง...
  </script>
</body>
</html>
