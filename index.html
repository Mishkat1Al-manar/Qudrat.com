<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ù…Ù†ØµÙ‘Ø© Ø§Ù„Ù‚Ø¯Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠØ© â€” Ø«Ø§Ù†ÙˆÙŠØ© Ù…Ø´ÙƒØ§Ø© Ø§Ù„Ù…Ù†Ø§Ø± Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220; --bg2:#0f1424; --card:#0c1222; --muted:#94a3b8;
      --primary:#1d4ed8; --accent:#f59e0b;
      --ok:#16a34a; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:'Tajawal',system-ui,Arial,Helvetica,sans-serif;color:#e5e7eb;
      background:
        radial-gradient(900px 600px at 85% -10%, rgba(29,78,216,.18), transparent 50%),
        radial-gradient(800px 500px at -10% -10%, rgba(245,158,11,.14), transparent 50%),
        linear-gradient(180deg,var(--bg),var(--bg2));
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));
      border:1px solid rgba(255,255,255,0.08); border-radius: 20px; backdrop-filter: blur(10px);
      box-shadow: 0 12px 50px rgba(2,6,23,.45);
    }
    .pill{ border-radius:999px; border:1px solid rgba(255,255,255,0.08); background:rgba(255,255,255,0.04) }
    .btn{ transition: transform .08s ease, background .2s ease; }
    .btn:hover{ transform: translateY(-1px); }
    .input{ background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.08);
            border-radius:14px; padding:.75rem 1rem; width:100%; outline:none; }
    .input:focus{ border-color: rgba(245,158,11,.6); box-shadow: 0 0 0 3px rgba(245,158,11,.15)}
    .seg{ display:flex; gap:.5rem; background:rgba(255,255,255,.05); padding:.4rem; border-radius:14px;}
    .seg button{ flex:1; padding:.55rem 1rem; border-radius:10px }
    .seg .active{ background:rgba(29,78,216,.2); border:1px solid rgba(29,78,216,.5) }
    .badge{ font-size:.8rem; padding:.2rem .6rem; border-radius:999px;
            background:rgba(245,158,11,.16); border:1px solid rgba(245,158,11,.4); color:#fde68a}
    .bar{ height:12px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; }
    .bar>div{ height:100%; background:linear-gradient(90deg, var(--accent), #fbbf24, #fde68a) }
    .tab{ cursor:pointer; padding:.5rem 1rem; border-radius:999px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.04) }
    .tab.active{ background:rgba(29,78,216,.2); border-color: rgba(29,78,216,.5) }
    .img-thumb{max-height:120px; border-radius:12px; border:1px solid rgba(255,255,255,.1)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
  </style>
</head>
<body>
  <header class="px-6 md:px-12 py-6">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-gradient-to-br from-blue-500 to-amber-400 shadow-lg"></div>
        <div>
          <h1 class="text-xl md:text-2xl font-extrabold tracking-tight">
            Ù…Ù†ØµÙ‘Ø© Ø§Ù„Ù‚Ø¯Ø±Ø§Øª Ø§Ù„Ø£Ø³Ø·ÙˆØ±ÙŠØ© â€” <span class="text-amber-300">Ù…Ø´ÙƒØ§Ø© Ø§Ù„Ù…Ù†Ø§Ø±</span>
          </h1>
          <p class="text-xs text-slate-400 -mt-1">Ø£Ø²Ø±Ù‚ Ù…Ù„ÙƒÙŠ Ã— Ø°Ù‡Ø¨ÙŠ â€” ÙØ®Ø§Ù…Ø© ğŸ‘‘</p>
        </div>
      </div>
      <nav class="flex items-center gap-2">
        <span id="whoami" class="hidden text-sm text-slate-300 pill px-3 py-1"></span>
        <span id="streakBadge" class="hidden text-sm pill px-3 py-1 border border-emerald-400/40 text-emerald-200">ğŸ”¥ Streak: 0</span>
        <span id="pointsBadge" class="hidden text-sm pill px-3 py-1 border border-amber-400/40 text-amber-200">Ù†Ù‚Ø§Ø·: 0</span>
        <button id="btnLogout" class="hidden btn px-4 py-2 pill hover:bg-white/10">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
      </nav>
    </div>
  </header>

  <main class="px-6 md:px-12 pb-16">
    <!-- Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù… -->
    <div id="announcement" class="hidden max-w-7xl mx-auto mb-4 p-4 rounded-xl bg-black/40 border border-white/10 flex items-center justify-between">
      <span id="announcementText" class="text-sm text-amber-200"></span>
      <button id="closeAnnouncement" class="text-xs text-slate-400 hover:text-white">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <!-- Auth -->
    <section id="authSection">
      <div class="max-w-4xl mx-auto grid md:grid-cols-2 gap-6">
        <!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ÙŠÙ…ÙŠÙ†) -->
        <div class="card p-6 md:p-8">
          <h2 class="text-2xl font-bold mb-4">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
          <div class="space-y-3">
            <input id="loginEmail" class="input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" type="email">
            <input id="loginPassword" class="input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" type="password">
            <button id="loginBtn" class="btn w-full py-2.5 rounded-xl bg-gradient-to-l from-blue-600 to-amber-500">Ø¯Ø®ÙˆÙ„</button>
          </div>
        </div>

        <!-- Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ (ÙŠØ³Ø§Ø±) -->
        <div class="card p-6 md:p-8">
          <h2 class="text-2xl font-bold mb-4">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h2>
          <div class="space-y-3">
            <div class="seg mb-2">
              <button id="roleStudent" class="active">Ø·Ø§Ù„Ø¨</button>
              <button id="roleTeacher">Ù…Ø¹Ù„Ù…</button>
            </div>
            <input id="regName" class="input" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" type="text">
            <input id="regEmail" class="input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" type="email">
            <input id="regPassword" class="input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" type="password">
            <div id="studentFields" class="grid grid-cols-2 gap-3">
              <select id="regGrade" class="input">
                <option value="" disabled selected>Ø§Ù„ØµÙ</option>
                <option value="Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ">Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ</option>
                <option value="Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ">Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ</option>
                <option value="Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ">Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ</option>
              </select>
              <select id="regClass" class="input">
                <option value="" disabled selected>Ø§Ù„ÙØµÙ„</option>
                <option value="1">1</option><option value="2">2</option>
                <option value="3">3</option><option value="4">4</option>
              </select>
            </div>
            <button id="registerBtn" class="btn w-full py-2.5 rounded-xl bg-gradient-to-l from-blue-600 to-amber-500">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
          </div>
        </div>
      </div>
    </section>

    <!-- App -->
    <section id="appSection" class="hidden max-w-7xl mx-auto">
      <!-- Motivation / Progress / Leaderboard shortcut -->
      <div id="motivation" class="card p-5 mb-6 grid md:grid-cols-3 gap-4">
        <div class="flex-1">
          <div class="text-sm text-amber-300 mb-1">Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙ‚Ø¯Ù…</div>
          <div class="bar"><div id="progressBar" style="width:0%"></div></div>
          <div class="mt-1 text-xs text-slate-300"><span id="progressText">0%</span> â€” <span id="motivationText">Ø§Ø³ØªÙ…Ø±ØŒ Ù‡Ø¯ÙÙ†Ø§ Ø¥ØªÙ‚Ø§Ù† Ø§Ù„Ù‚Ø¯Ø±Ø§Øª ğŸ‘‘</span></div>
        </div>
        <div class="flex items-center gap-2">
          <span id="badge1" class="hidden badge">ğŸ¯ Ù…Ø¨ØªØ¯Ø¦</span>
          <span id="badge2" class="hidden badge">ğŸ”¥ Ù…ØªÙ‚Ø¯Ù…</span>
          <span id="badge3" class="hidden badge">ğŸ† Ø£Ø³Ø·ÙˆØ±Ø©</span>
        </div>
        <div class="flex items-center justify-end gap-2">
          <a id="gotoAchievements" class="pill px-3 py-2 text-sm hover:bg-white/10 cursor-pointer">Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙŠ</a>
          <a id="gotoLeaderboard" class="pill px-3 py-2 text-sm hover:bg-white/10 cursor-pointer">Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</a>
        </div>
      </div>

      <!-- Tabs (Ø·Ø§Ù„Ø¨) -->
      <div id="studentTabs" class="hidden mb-4 flex flex-wrap gap-2">
        <button class="tab active" data-tab="all">ÙƒÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
        <button class="tab" data-tab="placement">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰</button>
        <button class="tab" data-tab="verbal">Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª â€” Ù„ÙØ¸ÙŠ</button>
        <button class="tab" data-tab="quant">Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª â€” ÙƒÙ…ÙŠ</button>
        <button class="tab" data-tab="achievements">Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙŠ</button>
        <button class="tab" data-tab="leaderboard">Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</button>
      </div>

      <!-- Student dashboard -->
      <div id="studentDash" class="hidden">
        <div class="grid grid-cols-12 gap-4">
          <div class="card p-5 col-span-12">
            <div class="flex items-center justify-between mb-3">
              <h3 id="testsTitle" class="text-xl font-bold">Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©</h3>
              <div class="flex items-center gap-2">
                <span class="badge" id="testsCount">0 Ø§Ø®ØªØ¨Ø§Ø±</span>
                <span class="badge" id="studentPoints">Ù†Ù‚Ø§Ø·Ùƒ: 0</span>
                <span class="badge" id="streakMini">ğŸ”¥ Streak: 0</span>
              </div>
            </div>
            <div id="testsList" class="space-y-3"></div>
          </div>

          <div class="card p-5 col-span-12 md:col-span-6">
            <h3 class="text-xl font-bold mb-3">Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙ… Ø­Ù„Ù‡Ø§</h3>
            <div id="solvedList" class="space-y-2 text-sm"></div>
          </div>

          <div class="card p-5 col-span-12 md:col-span-6">
            <h3 class="text-xl font-bold mb-3">Ù…Ø±Ø§Ø³Ù„Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h3>
            <textarea id="msgToAdmin" rows="4" class="input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„..."></textarea>
            <button id="sendMsgToAdmin" class="btn mt-2 pill px-3 py-2 bg-white/10 hover:bg-white/20">Ø¥Ø±Ø³Ø§Ù„</button>
            <div class="mt-4">
              <h4 class="font-bold mb-2">Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h4>
              <div id="studentReplies" class="space-y-2 text-sm"></div>
            </div>
          </div>

          <!-- Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙŠ -->
          <div class="card p-5 col-span-12" id="achievementsCard" style="display:none">
            <h3 class="text-xl font-bold mb-3">Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙŠ</h3>
            <div id="achievementsWrap" class="grid md:grid-cols-4 gap-3"></div>
          </div>

          <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø© -->
          <div class="card p-5 col-span-12" id="leaderboardCard" style="display:none">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-xl font-bold">Ù„ÙˆØ­Ø© Ø§Ù„ØµØ¯Ø§Ø±Ø©</h3>
              <span class="text-xs text-slate-400">ØªØµÙ†ÙŠÙ: Ù…Ø¨ØªØ¯Ø¦ / Ù…ØªÙ‚Ø¯Ù… / Ø£Ø³Ø·ÙˆØ±Ø©</span>
            </div>
            <div id="leaderboardWrap" class="space-y-2"></div>
          </div>
        </div>
      </div>

      <!-- Teacher dashboard -->
      <div id="teacherDash" class="hidden">
        <div class="grid grid-cols-12 gap-4">
          <div class="card p-5 col-span-12">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-xl font-bold">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
                <p class="text-slate-400 text-sm">Ø£Ù†Ø´Ø¦ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØªØ§Ø¨Ø¹ Ù…Ù† Ø­Ù„Ù‘Ù‡Ø§.</p>
              </div>
              <div class="text-sm text-amber-200">
                Ù…Ø¬Ù…ÙˆØ¹ Ø§Ø®ØªØ¨Ø§Ø±Ø§ØªÙƒ: <span id="teacherCount" class="font-bold"></span>
              </div>
            </div>
          </div>

          <div class="card p-5 col-span-12 md:col-span-7">
            <h4 class="text-lg font-bold mb-3">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±</h4>
            <input id="testTitle" class="input mb-2" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±">
            <select id="testCategory" class="input mb-3">
              <option value="placement">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰</option>
              <option value="verbal">ØªØ¬Ù…ÙŠØ¹Ø§Øª â€” Ù„ÙØ¸ÙŠ</option>
              <option value="quant">ØªØ¬Ù…ÙŠØ¹Ø§Øª â€” ÙƒÙ…ÙŠ</option>
            </select>
            <div id="questionsBox" class="space-y-4"></div>
            <div class="flex gap-2">
              <button id="addQuestion" class="btn pill px-3 py-2 bg-white/10 hover:bg-white/20">Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„</button>
              <button id="saveTest" class="btn pill px-3 py-2 bg-gradient-to-l from-blue-600 to-amber-500">Ø­ÙØ¸</button>
            </div>
          </div>

          <div class="card p-5 col-span-12 md:col-span-5">
            <h4 class="text-lg font-bold mb-3">Ø§Ø®ØªØ¨Ø§Ø±Ø§ØªÙŠ</h4>
            <div id="teacherTests" class="space-y-3"></div>
          </div>

          <div class="card p-5 col-span-12">
            <h4 class="text-lg font-bold mb-3">Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</h4>
            <div id="teacherQuestions" class="space-y-2 text-sm"></div>
          </div>

          <div class="card p-5 col-span-12">
            <h4 class="text-lg font-bold mb-3">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h4>
            <div id="profileTeacher" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
          </div>
        </div>
      </div>

      <!-- Admin dashboard -->
      <div id="adminDash" class="hidden">
        <div class="grid grid-cols-12 gap-4">
          <div class="card p-5 col-span-12">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-xl font-bold">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„</h3>
                <p class="text-slate-400 text-sm">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† â€¢ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª â€¢ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ â€¢ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„Ø¹Ø§Ù…</p>
              </div>
              <div>
                <span class="badge" id="statsUsers">0 Ù…Ø³ØªØ®Ø¯Ù…</span>
                <span class="badge" id="statsTests">0 Ø§Ø®ØªØ¨Ø§Ø±</span>
              </div>
            </div>
          </div>

          <!-- Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù… -->
          <div class="card p-5 col-span-12 md:col-span-6">
            <h4 class="text-lg font-bold mb-3">Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù…</h4>
            <textarea id="announceInput" class="input mb-2" placeholder="Ø§ÙƒØªØ¨ Ø¥Ø¹Ù„Ø§Ù† ÙŠØ¸Ù‡Ø± Ù„Ù„Ø¬Ù…ÙŠØ¹ (Ù…Ø«Ø§Ù„: Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ø®ØªØ¨Ø§Ø±ØŒ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª...)"></textarea>
            <div class="flex gap-2">
              <button id="setAnnounce" class="btn pill px-3 py-2 bg-white/10 hover:bg-white/20">Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
              <button id="clearAnnounce" class="btn pill px-3 py-2 bg-red-500/20 border border-red-500/30">Ù…Ø³Ø­ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†</button>
            </div>
          </div>

          <div class="card p-5 col-span-12 md:col-span-6">
            <h4 class="text-lg font-bold mb-3">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h4>
            <div id="adminInbox" class="space-y-3"></div>
          </div>

          <div class="card p-5 col-span-12 md:col-span-6">
            <h4 class="text-lg font-bold mb-3">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h4>
            <div id="adminUsers" class="space-y-2 text-sm"></div>
          </div>

          <div class="card p-5 col-span-12 md:col-span-6">
            <h4 class="text-lg font-bold mb-3 flex items-center gap-2">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª <span class="text-[11px] text-slate-400">(Ø§Ø¶ØºØ· â€œÙ†ØªØ§Ø¦Ø¬â€ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØªØµØ¯ÙŠØ±Ù‡Ø§)</span></h4>
            <div id="adminTests" class="space-y-3"></div>
          </div>
        </div>
      </div>

      <!-- Teacher Results page -->
      <div id="teacherResults" class="hidden max-w-7xl mx-auto">
        <div class="card p-5 mb-4 flex items-center justify-between">
          <h3 class="text-xl font-bold">Ù†ØªØ§Ø¦Ø¬ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
          <div class="flex items-center gap-2">
            <button id="exportTeacherCSV" class="btn pill px-3 py-1 bg-white/10 hover:bg-white/20">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (CSV)</button>
            <button id="backToTeacher" class="btn pill px-3 py-1 bg-white/10 hover:bg-white/20">Ø±Ø¬ÙˆØ¹</button>
          </div>
        </div>
        <div id="teacherResultsTable" class="space-y-2"></div>
      </div>

      <!-- Admin Results page -->
      <div id="adminResults" class="hidden max-w-7xl mx-auto">
        <div class="card p-5 mb-4 flex items-center justify-between">
          <h3 class="text-xl font-bold">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h3>
          <div class="flex items-center gap-2">
            <input id="adminSearchStudent" class="input w-44" placeholder="Ø¨Ø­Ø«...">
            <button id="exportAdminCSV" class="btn pill px-3 py-1 bg-white/10 hover:bg-white/20">â¬‡ï¸ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ (CSV)</button>
            <button id="backToAdmin" class="btn pill px-3 py-1 bg-white/10 hover:bg-white/20">Ø±Ø¬ÙˆØ¹</button>
          </div>
        </div>
        <div id="adminResultsTable" class="space-y-2"></div>
      </div>
    </section>
  </main>

  <!-- Modal: Ø­Ù„ Ø§Ø®ØªØ¨Ø§Ø± -->
  <div id="takeModal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/60">
    <div class="card w-[95%] max-w-2xl p-6">
      <div class="flex items-center justify-between mb-3">
        <h4 id="takeTitle" class="text-xl font-bold">Ø­Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</h4>
        <button onclick="closeTake()" class="pill px-3 py-1">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
      <div id="takeQuestions" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2"></div>
      <button id="submitAnswers" class="btn mt-3 w-full py-2 pill bg-gradient-to-l from-blue-600 to-amber-500">ØªØ³Ù„ÙŠÙ…</button>
      <div id="analysisBox" class="hidden mt-3 p-3 rounded-xl bg-white/5 border border-white/10"></div>
      <p id="takeResult" class="mt-2 text-center text-slate-200"></p>
    </div>
  </div>

  <script>
    // ===== Local "DB" via localStorage =====
    const DB = {
      users: 'mq_users',
      tests: 'mq_tests',
      msgs: 'mq_msgs',
      results: 'mq_results',       // {userId, testId, score, total, at, perQ:[0/1], category}
      inquiries: 'mq_inquiries',   // {id, fromUserId, toTeacherId, testId, qIndex, text, replies[], at}
      ANN_KEY: 'mq_announce',
      seed(){
        const u = JSON.parse(localStorage.getItem(this.users)||'[]');
        if(!u.find(x=>x.email==='admin@gmail.com')){
          u.push({id:crypto.randomUUID(), role:'admin', name:'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…', email:'admin@gmail.com', password:'admin123456', points:0, streak:0});
          localStorage.setItem(this.users, JSON.stringify(u));
        }
        for(const k of [this.tests,this.msgs,this.results,this.inquiries]) if(!localStorage.getItem(k)) localStorage.setItem(k,'[]');

        // Seed sample tests (once)
        const t = JSON.parse(localStorage.getItem(this.tests)||'[]');
        if(t.length===0){
          const sample = (title,cat)=>({
            id:crypto.randomUUID(),
            title, category:cat, questions:[
              {text:'Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±Ø§Ø¯Ù Ø§Ù„ØµØ­ÙŠØ­ Ù„ÙƒÙ„Ù…Ø© "Ø¬Ù„ÙŠÙ„"', choices:['Ø¹Ø¸ÙŠÙ…','Ù‚Ù„ÙŠÙ„','Ø³Ø±ÙŠØ¹','Ù‚Ø¯ÙŠÙ…'], correctIndex:0},
              {text:'Ù‚ÙŠÙ…Ø© 3x+2 Ø¹Ù†Ø¯ x=4 Ù‡ÙŠØŸ', choices:['10','12','14','20'], correctIndex:2},
              {text:'Ù†Ø§ØªØ¬ 5Ã—6ØŸ', choices:['30','20','36','26'], correctIndex:0},
            ], createdAt:Date.now(), teacherId:null, teacherName:'â€”'
          });
          t.push(sample('ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªÙˆÙ‰ â€” ØªØ¬Ø±Ø¨Ø©', 'placement'));
          t.push(sample('ØªØ¬Ù…ÙŠØ¹Ø§Øª Ù„ÙØ¸ÙŠ â€” Ø¯ÙØ¹Ø© 1', 'verbal'));
          t.push(sample('ØªØ¬Ù…ÙŠØ¹Ø§Øª ÙƒÙ…ÙŠ â€” Ø¯ÙØ¹Ø© 1', 'quant'));
          localStorage.setItem(this.tests, JSON.stringify(t));
        }
      },
      getUsers(){ return JSON.parse(localStorage.getItem(this.users)||'[]'); },
      setUsers(v){ localStorage.setItem(this.users, JSON.stringify(v)); },
      getTests(){ return JSON.parse(localStorage.getItem(this.tests)||'[]'); },
      setTests(v){ localStorage.setItem(this.tests, JSON.stringify(v)); },
      getMsgs(){ return JSON.parse(localStorage.getItem(this.msgs)||'[]'); },
      setMsgs(v){ localStorage.setItem(this.msgs, JSON.stringify(v)); },
      getResults(){ return JSON.parse(localStorage.getItem(this.results)||'[]'); },
      setResults(v){ localStorage.setItem(this.results, JSON.stringify(v)); },
      getInquiries(){ return JSON.parse(localStorage.getItem(this.inquiries)||'[]'); },
      setInquiries(v){ localStorage.setItem(this.inquiries, JSON.stringify(v)); },
      getAnn(){ return localStorage.getItem(this.ANN_KEY)||''; },
      setAnn(msg){ localStorage.setItem(this.ANN_KEY,msg||''); }
    };
    DB.seed();

    const roles = { student:'Ø·Ø§Ù„Ø¨', teacher:'Ù…Ø¹Ù„Ù…', admin:'Ù…Ø³Ø¤ÙˆÙ„' };
    const $ = s=>document.querySelector(s);
    const $$ = s=>document.querySelectorAll(s);
    let currentUser = JSON.parse(sessionStorage.getItem('mq_current')||'null');

    const toast = (msg,type='ok')=>{
      const el = document.createElement('div');
      el.className='fixed bottom-6 right-6 z-[60] px-4 py-2 rounded-xl text-sm '+
        (type==='ok'?'bg-emerald-600/90':'')+(type==='warn'?' bg-amber-600/90':'')+(type==='err'?' bg-red-600/90':'');
      el.textContent=msg; document.body.appendChild(el); setTimeout(()=>el.remove(),1800);
    };
    const saveSession = ()=> sessionStorage.setItem('mq_current', JSON.stringify(currentUser));
    const logout = ()=>{ currentUser=null; saveSession(); location.reload(); };
    $('#btnLogout').onclick = logout;

    // ===== Helpers =====
    const todayKey = ()=> new Date().toISOString().slice(0,10); // YYYY-MM-DD
    function sameDay(d1, d2){ return d1 && d2 && d1.slice(0,10) === d2.slice(0,10); }
    function yesterKey(){
      const d = new Date(); d.setDate(d.getDate()-1);
      return d.toISOString().slice(0,10);
    }

    // ===== Auth =====
    const setRoleButtons = (r)=>{
      $('#roleStudent').classList.toggle('active', r==='student');
      $('#roleTeacher').classList.toggle('active', r==='teacher');
      $('#studentFields').style.display = r==='student' ? '' : 'none';
    };
    let regRole='student';
    $('#roleStudent').onclick=()=>{regRole='student'; setRoleButtons(regRole)};
    $('#roleTeacher').onclick=()=>{regRole='teacher'; setRoleButtons(regRole)};

    $('#registerBtn').onclick = ()=>{
      const name = $('#regName').value.trim();
      const email = $('#regEmail').value.trim().toLowerCase();
      const password = $('#regPassword').value;
      if(!name||!email||!password) return toast('Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„','warn');
      const users=DB.getUsers();
      if(users.find(u=>u.email===email)) return toast('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù…','err');
      const newUser={id:crypto.randomUUID(), role:regRole, name,email,password, points:0, streak:0, lastActive:null};
      if(regRole==='student'){
        const g=$('#regGrade').value, c=$('#regClass').value;
        if(!g||!c) return toast('Ø§Ø®ØªØ± Ø§Ù„ØµÙ ÙˆØ§Ù„ÙØµÙ„','warn');
        newUser.grade=g; newUser.class=c;
      }
      users.push(newUser); DB.setUsers(users);
      toast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨');
      $('#regName').value=$('#regEmail').value=$('#regPassword').value='';
    };

    $('#loginBtn').onclick = ()=>{
      const email=$('#loginEmail').value.trim().toLowerCase();
      const password=$('#loginPassword').value;
      const user=DB.getUsers().find(u=>u.email===email && u.password===password);
      if(!user) return toast('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©','err');
      currentUser=user; // streak ØªØ­Ø¯ÙŠØ« Ù„Ø§Ø­Ù‚Ø§Ù‹
      updateStreakOnLogin();
      saveSession();
      $('#authSection').classList.add('hidden');
      $('#appSection').classList.remove('hidden');
      $('#btnLogout').classList.remove('hidden'); $('#whoami').classList.remove('hidden');
      $('#whoami').textContent=`${roles[user.role]} â€” ${user.name}`;
      $('#pointsBadge').classList.remove('hidden');
      $('#streakBadge').classList.remove('hidden');
      route();
      toast('Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ');
    };

    // ===== Profile (Ù…Ø´ØªØ±Ùƒ) =====
    function buildProfileForm(containerId){
      const c=$(containerId); c.innerHTML='';
      const base=`
        <input id="pName" class="input" placeholder="Ø§Ù„Ø§Ø³Ù…" value="${currentUser.name||''}">
        <input id="pEmail" class="input" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯" value="${currentUser.email||''}">
        <input id="pPass" class="input" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" type="password">
        <div class="flex gap-2">
          <button id="pSave" class="btn pill px-3 py-2 bg-white/10 hover:bg-white/20">Ø­ÙØ¸</button>
          <button id="pDelete" class="btn pill px-3 py-2 border border-red-500/40 text-red-300 hover:bg-red-500/10">Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨</button>
        </div>`;
      c.insertAdjacentHTML('beforeend', base);
      $('#pSave').onclick=()=>{
        const users=DB.getUsers();
        const idx=users.findIndex(u=>u.id===currentUser.id);
        users[idx].name=$('#pName').value.trim();
        users[idx].email=$('#pEmail').value.trim().toLowerCase();
        const np=$('#pPass').value; if(np) users[idx].password=np;
        DB.setUsers(users); currentUser=users[idx]; saveSession();
        $('#whoami').textContent=`${roles[currentUser.role]} â€” ${currentUser.name}`;
        toast('ØªÙ… Ø§Ù„Ø­ÙØ¸'); updateBadgesAndBars(); updatePointsUI();
      };
      $('#pDelete').onclick=()=>{
        if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ')) return;
        const users=DB.getUsers().filter(u=>u.id!==currentUser.id);
        DB.setUsers(users);
        DB.setMsgs(DB.getMsgs().filter(m=>m.from!==currentUser.id));
        DB.setResults(DB.getResults().filter(r=>r.userId!==currentUser.id));
        DB.setInquiries(DB.getInquiries().filter(q=>q.fromUserId!==currentUser.id));
        toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ø³Ø§Ø¨','warn'); logout();
      };
    }

    // ===== Streak =====
    function updateStreakOnLogin(){
      const users=DB.getUsers();
      const idx=users.findIndex(u=>u.id===currentUser.id);
      const last = users[idx].lastActive || null;
      const today = todayKey();
      if(sameDay(last, today)){
        // Ù„Ø§ Ø´ÙŠØ¡
      }else if(last === yesterKey()){
        users[idx].streak = (users[idx].streak||0) + 1;
      }else{
        users[idx].streak = 1;
      }
      users[idx].lastActive = today;
      DB.setUsers(users);
      currentUser = users[idx];
    }
    function refreshStreakUI(){
      const s = currentUser.streak || 0;
      const sb = $('#streakBadge'); if(sb){ sb.textContent = 'ğŸ”¥ Streak: '+s; }
      const sm = $('#streakMini'); if(sm){ sm.textContent = 'ğŸ”¥ Streak: '+s; }
    }

    // ===== Results / Points =====
    function solvedByUser(userId){ return DB.getResults().filter(r=>r.userId===userId); }
    function isSolved(userId,testId){ return DB.getResults().some(r=>r.userId===userId && r.testId===testId); }
    function recalcPoints(userId){
      const users = DB.getUsers();
      const idx = users.findIndex(u=>u.id===userId);
      const solvedCount = solvedByUser(userId).length;
      const pts = solvedCount * 10; // ÙƒÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø¹Ù„ÙŠÙ‡ 10 Ù†Ù‚Ø§Ø·
      users[idx].points = pts;
      DB.setUsers(users);
      if(currentUser && currentUser.id===userId){ currentUser=users[idx]; saveSession(); }
      return pts;
    }
    function updatePointsUI(){
      if(!currentUser) return;
      const pts = currentUser.points || 0;
      const pb = $('#pointsBadge');
      if(pb){ pb.textContent = 'Ù†Ù‚Ø§Ø·: '+pts; }
      const sp = $('#studentPoints');
      if(sp){ sp.textContent = 'Ù†Ù‚Ø§Ø·Ùƒ: '+pts; }
    }

    // ===== Motivation / Achievements / Leaderboard =====
    const phrases = [
      'Ø§Ø³ØªÙ…Ø±ØŒ Ù‡Ø¯ÙÙ†Ø§ Ø¥ØªÙ‚Ø§Ù† Ø§Ù„Ù‚Ø¯Ø±Ø§Øª ğŸ‘‘',
      'ÙƒÙ„ Ø³Ø¤Ø§Ù„ ÙŠÙ‚ÙˆÙ‘ÙŠ Ø¹Ø¶Ù„ØªÙƒ Ø§Ù„Ø°Ù‡Ù†ÙŠØ© ğŸ’ª',
      'Ø®Ø·ÙˆØ© Ø§Ù„ÙŠÙˆÙ… ØªØµÙ†Ø¹ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ğŸ',
      'ØªØ±ÙƒÙŠØ²Ùƒ Ø§Ù„Ø¢Ù† = Ù†Ù‚Ø§Ø· Ø£Ø¹Ù„Ù‰ Ù„Ø§Ø­Ù‚Ø§Ù‹ âœ¨',
    ];
    function rotateMotivation(){
      const el = document.getElementById('motivationText'); let i=0;
      setInterval(()=>{ i=(i+1)%phrases.length; el.textContent=phrases[i]; }, 4000);
    }
    function updateBadgesAndBars(){
      if(currentUser.role!=='student') { document.getElementById('motivation').classList.add('hidden'); return; }
      document.getElementById('motivation').classList.remove('hidden');
      const total=DB.getTests().length;
      const solved=solvedByUser(currentUser.id).length;
      const pct = total? Math.round((solved/total)*100):0;
      $('#progressBar').style.width=pct+'%';
      $('#progressText').textContent=pct+'%';
      $('#badge1').classList.toggle('hidden', solved<1);
      $('#badge2').classList.toggle('hidden', solved<5);
      $('#badge3').classList.toggle('hidden', solved<10);
    }

    function buildAchievements(){
      const wrap = $('#achievementsWrap'); wrap.innerHTML='';
      const solved = solvedByUser(currentUser.id);
      const totalSolved = solved.length;
      const mastered = solved.reduce((acc,r)=> acc + (r.perQ? r.perQ.filter(x=>x===1).length : 0), 0);
      const points = currentUser.points||0;
      const badges = [
        totalSolved>=1 ? 'ğŸ¯ Ù…Ø¨ØªØ¯Ø¦' : null,
        totalSolved>=5 ? 'ğŸ”¥ Ù…ØªÙ‚Ø¯Ù…' : null,
        totalSolved>=10? 'ğŸ† Ø£Ø³Ø·ÙˆØ±Ø©' : null
      ].filter(Boolean);

      const card = (title,val,sub='')=>`<div class="p-4 rounded-xl bg-white/5 border border-white/10">
        <div class="text-slate-400 text-sm">${title}</div>
        <div class="text-2xl font-extrabold mt-1">${val}</div>
        ${sub?`<div class="text-xs text-slate-400 mt-1">${sub}</div>`:''}
      </div>`;

      wrap.insertAdjacentHTML('beforeend', card('Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø­Ù„ÙˆÙ„Ø©', totalSolved));
      wrap.insertAdjacentHTML('beforeend', card('Ø£Ø³Ø¦Ù„Ø© Ù…ØªÙ‚Ù†Ø©', mastered));
      wrap.insertAdjacentHTML('beforeend', card('Ø§Ù„Ù†Ù‚Ø§Ø·', points));
      wrap.insertAdjacentHTML('beforeend', card('Ø§Ù„Ø£ÙˆØ³Ù…Ø©', badges.join(' â€¢ ') || 'â€”'));
    }

    function buildLeaderboard(){
      const wrap = $('#leaderboardWrap'); wrap.innerHTML='';
      const users = DB.getUsers().filter(u=>u.role==='student').sort((a,b)=>(b.points||0)-(a.points||0));
      users.forEach((u,i)=>{
        let tier='Ù…Ø¨ØªØ¯Ø¦'; if((u.points||0)>=50) tier='Ù…ØªÙ‚Ø¯Ù…'; if((u.points||0)>=100) tier='Ø£Ø³Ø·ÙˆØ±Ø©';
        const row = document.createElement('div');
        row.className='p-3 rounded-lg bg-white/5 border border-white/10 flex items-center justify-between';
        row.innerHTML = `<div class="text-sm">
           <span class="mono text-slate-400">#${i+1}</span> <span class="font-bold">${u.name}</span> â€” <span class="text-xs text-slate-400">${u.grade||''} ${u.class?('â€¢ ÙØµÙ„ '+u.class):''}</span>
         </div>
         <div class="flex items-center gap-3">
           <span class="badge">${tier}</span>
           <span class="text-amber-200">Ù†Ù‚Ø§Ø·: ${u.points||0}</span>
         </div>`;
        wrap.appendChild(row);
      });
    }

    // ===== Student =====
    function labelCat(cat){
      return cat==='placement'?'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰':cat==='verbal'?'ØªØ¬Ù…ÙŠØ¹Ø§Øª Ù„ÙØ¸ÙŠ':cat==='quant'?'ØªØ¬Ù…ÙŠØ¹Ø§Øª ÙƒÙ…ÙŠ':'â€”';
    }
    function setStudentTab(tab){
      $$('#studentTabs .tab').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
      const all=DB.getTests();
      if(tab==='achievements'){ $('#achievementsCard').style.display=''; $('#leaderboardCard').style.display='none'; buildAchievements(); return; }
      if(tab==='leaderboard'){ $('#leaderboardCard').style.display=''; $('#achievementsCard').style.display='none'; buildLeaderboard(); return; }
      $('#achievementsCard').style.display='none';
      $('#leaderboardCard').style.display='none';

      let list=all;
      if(tab==='placement') list=all.filter(t=>t.category==='placement');
      if(tab==='verbal') list=all.filter(t=>t.category==='verbal');
      if(tab==='quant') list=all.filter(t=>t.category==='quant');

      // available tests = not solved
      const available=list.filter(t=>!isSolved(currentUser.id,t.id));
      $('#testsTitle').textContent =
        tab==='all' ? 'Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©' :
        tab==='placement' ? 'Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³ØªÙˆÙ‰' :
        tab==='verbal' ? 'Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª â€” Ù„ÙØ¸ÙŠ' : 'Ø§Ù„ØªØ¬Ù…ÙŠØ¹Ø§Øª â€” ÙƒÙ…ÙŠ';
      $('#testsCount').textContent = `${available.length} Ø§Ø®ØªØ¨Ø§Ø±`;

      const wrap=document.getElementById('testsList'); wrap.innerHTML='';
      available.forEach(t=>{
        const row=document.createElement('div');
        row.className='p-3 rounded-xl bg-white/5 border border-white/10 flex items-center justify-between gap-3';
        row.innerHTML=`<div>
            <div class="font-bold">${t.title}</div>
            <div class="text-xs text-slate-400">Ù†ÙˆØ¹: ${labelCat(t.category)} â€¢ Ø£Ø³Ø¦Ù„Ø©: ${t.questions.length}</div>
          </div>
          <button class="btn pill px-3 py-1 bg-gradient-to-l from-blue-600 to-amber-500">Ø§Ø¨Ø¯Ø£</button>`;
        row.querySelector('button').onclick=()=>openTake(t);
        wrap.appendChild(row);
      });

      // solved list
      const solved=solvedByUser(currentUser.id).map(r=>{
        const t=all.find(x=>x.id===r.testId);
        return {title:t?t.title:'Ø§Ø®ØªØ¨Ø§Ø±', score:r.score, total:r.total, category:t?t.category:'â€”'};
      });
      const sWrap=document.getElementById('solvedList'); sWrap.innerHTML='';
      solved.forEach(s=>{
        const el=document.createElement('div');
        el.className='p-3 rounded-lg bg-white/5 border border-white/10 flex items-center justify-between';
        el.innerHTML=`<div class="text-sm"><span class="font-bold">${s.title}</span> <span class="text-xs text-slate-400">â€” ${labelCat(s.category)}</span></div>
                      <div class="text-xs text-emerald-300">Ù†ØªÙŠØ¬ØªÙƒ: ${s.score}/${s.total}</div>`;
        sWrap.appendChild(el);
      });

      // replies + profile + progress
      loadStudentReplies();
      buildProfileForm('#profileStudent');
      updateBadgesAndBars();
      refreshStreakUI();
      document.getElementById('studentTabs').classList.remove('hidden');
    }
    function showStudent(){ setStudentTab('all'); }
    $('#gotoAchievements').onclick = ()=> setStudentTab('achievements');
    $('#gotoLeaderboard').onclick = ()=> setStudentTab('leaderboard');

    // ===== Teacher =====
    let qCount=0;
    function addQuestionUI(){
      const idx=++qCount;
      const box=document.createElement('div');
      box.className='p-3 rounded-xl bg-white/5 border border-white/10';
      const id = 'qf_'+idx+'_'+Math.random().toString(36).slice(2,7);
      box.innerHTML=`
        <div class="font-bold mb-2">Ø³Ø¤Ø§Ù„ ${idx}</div>
        <input class="input mb-2" placeholder="Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
          <input class="input" placeholder="Ø§Ø®ØªÙŠØ§Ø± 1">
          <input class="input" placeholder="Ø§Ø®ØªÙŠØ§Ø± 2">
          <input class="input" placeholder="Ø§Ø®ØªÙŠØ§Ø± 3">
          <input class="input" placeholder="Ø§Ø®ØªÙŠØ§Ø± 4">
        </div>
        <div class="mt-2 text-sm text-slate-300">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©:</div>
        <select class="input mt-1 mb-2">
          <option value="0">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± 1</option>
          <option value="1">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± 2</option>
          <option value="2">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± 3</option>
          <option value="3">Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± 4</option>
        </select>
        <div class="mt-2 text-sm text-slate-300">(Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØµÙˆØ±Ø© Ù„Ù„Ø³Ø¤Ø§Ù„:</div>
        <input type="file" accept="image/*" id="${id}" class="input">
        <div class="mt-2" data-preview></div>`;
      document.getElementById('questionsBox').appendChild(box);

      const fileInput = box.querySelector('#'+id);
      const preview = box.querySelector('[data-preview]');
      fileInput.onchange = ()=>{
        const file = fileInput.files?.[0]; if(!file) return;
        const reader=new FileReader();
        reader.onload=()=>{ preview.innerHTML=`<img src="${reader.result}" class="img-thumb">`; preview.dataset.url=reader.result; };
        reader.readAsDataURL(file);
      };
    }
    document.getElementById('addQuestion').onclick=addQuestionUI;

    document.getElementById('saveTest').onclick=()=>{
      const title=document.getElementById('testTitle').value.trim();
      const category=document.getElementById('testCategory').value;
      if(!title) return toast('Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±','warn');
      const blocks=Array.from(document.getElementById('questionsBox').children);
      if(blocks.length===0) return toast('Ø£Ø¶Ù Ø£Ø³Ø¦Ù„Ø©','warn');
      const qs=blocks.map(b=>{
        const ins=b.querySelectorAll('input'); const sel=b.querySelector('select');
        const text=ins[0].value.trim();
        const choices=[ins[1].value.trim(), ins[2].value.trim(), ins[3].value.trim(), ins[4].value.trim()];
        const ok = choices.every(x=>x && x.length>0);
        const preview=b.querySelector('[data-preview]');
        const img = preview?.dataset?.url || null;
        return ok && text ? {text, choices, correctIndex: parseInt(sel.value), image:img} : null;
      }).filter(Boolean);
      if(qs.length!==blocks.length) return toast('Ø£ÙƒÙ…Ù„ ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙˆØ§Ù„Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ø±Ø¨Ø¹Ø©','warn');
      const tests=DB.getTests();
      tests.push({id:crypto.randomUUID(), title, category, questions:qs, teacherId:currentUser.id, teacherName:currentUser.name, createdAt:Date.now()});
      DB.setTests(tests);
      document.getElementById('testTitle').value=''; document.getElementById('questionsBox').innerHTML=''; qCount=0;
      toast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±'); showTeacher();
    };

    function showTeacher(){
      const mine=DB.getTests().filter(t=>t.teacherId===currentUser.id);
      $('#teacherCount').textContent=mine.length;
      const wrap=$('#teacherTests'); wrap.innerHTML='';
      if(mine.length===0) wrap.innerHTML='<div class="text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª.</div>';
      mine.forEach(t=>{
        const solved=DB.getResults().filter(r=>r.testId===t.id).length;
        const row=document.createElement('div');
        row.className='p-3 rounded-xl bg-white/5 border border-white/10 space-y-2';
        row.innerHTML=`<div class="flex items-center justify-between">
          <div><div class="font-bold">${t.title}</div>
            <div class="text-xs text-slate-400">Ù†ÙˆØ¹: ${labelCat(t.category)} â€¢ Ø£Ø³Ø¦Ù„Ø©: ${t.questions.length} â€¢ Ø­Ù„Ù‘Ù‡: ${solved} Ø·Ø§Ù„Ø¨</div>
          </div>
          <div class="flex gap-2">
            <button class="btn pill px-3 py-1 bg-white/10 hover:bg-white/20" data-res>Ù†ØªØ§Ø¦Ø¬</button>
            <button class="btn pill px-3 py-1 bg-red-500/20 border border-red-500/30" data-del>Ø­Ø°Ù</button>
          </div>
        </div>`;
        row.querySelector('[data-res]').onclick=()=> openTeacherResults(t.id);
        row.querySelector('[data-del]').onclick=()=>{
          if(!confirm('Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ')) return;
          DB.setTests(DB.getTests().filter(x=>x.id!==t.id));
          DB.setResults(DB.getResults().filter(r=>r.testId!==t.id));
          toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','warn'); showTeacher();
        };
        wrap.appendChild(row);
      });
      // Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…ÙˆØ¬Ù‡Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù…
      buildTeacherInquiries();
      buildProfileForm('#profileTeacher');
      document.getElementById('motivation').classList.add('hidden');
    }

    function buildTeacherInquiries(){
      const wrap = $('#teacherQuestions'); wrap.innerHTML='';
      const qs = DB.getInquiries().filter(q=>q.toTeacherId===currentUser.id).sort((a,b)=>b.at-a.at);
      const users = DB.getUsers();
      const tests = DB.getTests();
      if(qs.length===0){ wrap.innerHTML = '<div class="text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª.</div>'; return; }
      qs.forEach(q=>{
        const stu = users.find(u=>u.id===q.fromUserId);
        const test = tests.find(t=>t.id===q.testId);
        const div=document.createElement('div');
        div.className='p-3 rounded-lg bg-white/5 border border-white/10';
        div.innerHTML = `
          <div class="text-sm">
            <div class="font-bold">${stu?stu.name:'Ø·Ø§Ù„Ø¨'} <span class="text-xs text-slate-400">Ø³Ø¤Ø§Ù„ ${q.qIndex+1} â€” ${test?test.title:'Ø§Ø®ØªØ¨Ø§Ø±'}</span></div>
            <div class="mt-1">${q.text}</div>
            ${(q.replies||[]).map(r=>`<div class="text-xs text-emerald-300 mt-1">Ø±Ø¯: ${r.content}</div>`).join('')}
          </div>
          <div class="mt-2 flex gap-2">
            <input class="input flex-1" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯..." />
            <button class="btn pill px-3 py-1 bg-white/10 hover:bg-white/20">Ø¥Ø±Ø³Ø§Ù„</button>
          </div>
        `;
        const input = div.querySelector('input');
        div.querySelector('button').onclick = ()=>{
          const t = input.value.trim(); if(!t) return toast('Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯','warn');
          q.replies = q.replies||[]; q.replies.push({content:t, at:Date.now()});
          const rest = DB.getInquiries().map(x=>x.id===q.id?q:x);
          DB.setInquiries(rest); toast('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'); buildTeacherInquiries();
        };
        wrap.appendChild(div);
      });
    }

    // ===== Admin =====
    function showAdmin(){
      const users=DB.getUsers(), tests=DB.getTests();
      $('#statsUsers').textContent=`${users.length} Ù…Ø³ØªØ®Ø¯Ù…`; $('#statsTests').textContent=`${tests.length} Ø§Ø®ØªØ¨Ø§Ø±`;

      // users
      const uWrap=$('#adminUsers'); uWrap.innerHTML='';
      users.forEach(u=>{
        const row=document.createElement('div');
        row.className='p-3 rounded-lg bg-white/5 border border-white/10 flex items-center justify-between';
        row.innerHTML=`<div class="text-sm">
          <div class="font-bold">${u.name} <span class="badge text-[11px]">${roles[u.role]}</span></div>
          <div class="text-xs text-slate-400">${u.email}${u.grade? ' â€¢ '+u.grade:''}${u.class?' â€¢ ÙØµÙ„ '+u.class:''} â€¢ Ù†Ù‚Ø§Ø·: ${u.points||0} â€¢ Streak: ${u.streak||0}</div>
        </div>
        <div>${u.role!=='admin'?'<button class="btn pill px-3 py-1 bg-red-500/20 border border-red-500/30">Ø­Ø°Ù</button>':'â€”'}</div>`;
        if(u.role!=='admin'){
          row.querySelector('button').onclick=()=>{
            if(!confirm('Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŸ')) return;
            DB.setUsers(users.filter(x=>x.id!==u.id));
            DB.setMsgs(DB.getMsgs().filter(m=>m.from!==u.id));
            DB.setResults(DB.getResults().filter(r=>r.userId!==u.id));
            DB.setInquiries(DB.getInquiries().filter(q=>q.fromUserId!==u.id));
            toast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…','warn'); showAdmin();
          };
        }
        uWrap.appendChild(row);
      });

      // tests
      const tWrap=$('#adminTests'); tWrap.innerHTML='';
      tests.forEach(t=>{
        const solved=DB.getResults().filter(r=>r.testId===t.id).length;
        const row=document.createElement('div');
        row.className='p-3 rounded-lg bg-white/5 border border-white/10 flex items-center justify-between gap-2';
        row.innerHTML=`<div class="text-sm"><div class="font-bold">${t.title}</div>
          <div class="text-xs text-slate-400">Ù†ÙˆØ¹: ${labelCat(t.category)} â€¢ Ø§Ù„Ù…Ø¹Ù„Ù…: ${t.teacherName||'â€”'} â€¢ Ø£Ø³Ø¦Ù„Ø©: ${t.questions.length} â€¢ ØªÙ… Ø­Ù„Ù‡: ${solved}</div></div>
          <div class="flex gap-2">
            <button class="btn pill px-3 py-1 bg-white/10 hover:bg-white/20" data-res>Ù†ØªØ§Ø¦Ø¬</button>
            <button class="btn pill px-3 py-1 bg-red-500/20 border border-red-500/30" data-del>Ø­Ø°Ù</button>
          </div>`;
        row.querySelector('[data-res]').onclick=()=> openAdminResults(t.id);
        row.querySelector('[data-del]').onclick=()=>{
          if(!confirm('Ø­Ø°Ù Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±ØŸ')) return;
          DB.setTests(tests.filter(x=>x.id!==t.id));
          DB.setResults(DB.getResults().filter(r=>r.testId!==t.id));
          toast('ØªÙ… Ø§Ù„Ø­Ø°Ù','warn'); showAdmin();
        };
        tWrap.appendChild(row);
      });

      // inbox (Ù…Ø³Ø¤ÙˆÙ„)
      const inbox=DB.getMsgs().sort((a,b)=>b.createdAt-a.createdAt);
      const iWrap=$('#adminInbox'); iWrap.innerHTML='';
      inbox.forEach(m=>{
        const sender=users.find(u=>u.id===m.from);
        const div=document.createElement('div');
        div.className='p-3 rounded-lg bg-white/5 border border-white/10';
        const last=(m.replies||[]).slice(-1)[0];
        div.innerHTML=`<div class="flex items-center justify-between gap-3">
          <div class="text-sm">
            <div class="font-bold">${sender?sender.name:'Ù…Ø³ØªØ®Ø¯Ù…'} <span class="text-xs text-slate-400">(${sender?roles[sender.role]:''})</span></div>
            <div class="text-slate-200 mt-1">${m.content}</div>
            ${last?`<div class="text-xs text-emerald-300 mt-1">Ø¢Ø®Ø± Ø±Ø¯: ${last.content}</div>`:''}
          </div>
          <div class="min-w-[240px]">
            <textarea rows="2" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯..." class="input mb-2"></textarea>
            <button class="btn pill px-3 py-1 bg-white/10 hover:bg-white/20 w-full">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</button>
          </div>
        </div>`;
        const area=div.querySelector('textarea');
        div.querySelector('button').onclick=()=>{
          const txt=area.value.trim(); if(!txt) return toast('Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯','warn');
          m.replies=m.replies||[]; m.replies.push({content:txt, at:Date.now()});
          const rest=DB.getMsgs().map(x=>x.id===m.id?m:x); DB.setMsgs(rest); toast('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'); showAdmin();
        };
        iWrap.appendChild(div);
      });

      // Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù… ØªØ­Ù…ÙŠÙ„
      const ann = DB.getAnn();
      $('#announceInput').value = ann || '';
    }

    // Ø¥Ø¹Ù„Ø§Ù† Ø¹Ø§Ù… (Ø¹Ø±Ø¶)
    function loadAnnouncement(){
      const msg = DB.getAnn();
      const box = $('#announcement');
      const txt = $('#announcementText');
      if(msg && currentUser){ txt.textContent = msg; box.classList.remove('hidden'); } else { box.classList.add('hidden'); }
      $('#closeAnnouncement').onclick = ()=> box.classList.add('hidden');
    }
    const btnSetAnn = $('#setAnnounce');
    const btnClrAnn = $('#clearAnnounce');
    if(btnSetAnn){
      btnSetAnn.onclick = ()=>{ DB.setAnn(($('#announceInput').value||'').trim()); loadAnnouncement(); toast('ØªÙ… Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†'); };
      btnClrAnn.onclick = ()=>{ DB.setAnn(''); loadAnnouncement(); toast('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†','warn'); };
    }

    // Ø·Ø§Ù„Ø¨: Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„
    function loadStudentReplies(){
      const msgs=DB.getMsgs().filter(m=>m.from===currentUser.id);
      const wrap=$('#studentReplies'); wrap.innerHTML='';
      msgs.forEach(m=>{
        const last=(m.replies||[]).slice(-1)[0];
        const el=document.createElement('div');
        el.className='p-3 rounded-lg bg-white/5 border border-white/10';
        el.innerHTML=`<div class="text-sm">${m.content}</div>
                      <div class="text-xs text-slate-400 mt-1">${last?('Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: '+last.content):'Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„'}</div>`;
        wrap.appendChild(el);
      });
    }

    // ===== Router =====
    function route(){
      ['studentDash','teacherDash','adminDash','teacherResults','adminResults'].forEach(id=>document.getElementById(id).classList.add('hidden'));
      $('#studentTabs').classList.add('hidden');

      if(currentUser.role==='student'){ $('#studentDash').classList.remove('hidden'); $('#studentTabs').classList.remove('hidden'); showStudent(); }
      if(currentUser.role==='teacher'){ $('#teacherDash').classList.remove('hidden'); showTeacher(); }
      if(currentUser.role==='admin'){ $('#adminDash').classList.remove('hidden'); showAdmin(); }
      loadAnnouncement();
      updatePointsUI();
      refreshStreakUI();
    }

    // ===== Take test modal (with analysis & inquiries) =====
    let takeCurrent=null;
    function openTake(test){
      takeCurrent=test;
      $('#takeTitle').textContent=`Ø­Ù„ Ø§Ø®ØªØ¨Ø§Ø±: ${test.title}`;
      const wrap=$('#takeQuestions'); wrap.innerHTML='';
      test.questions.forEach((q,qi)=>{
        const box=document.createElement('div');
        box.className='p-3 rounded-xl bg-white/5 border border-white/10';
        box.innerHTML=`<div class="font-bold mb-2">${qi+1}. ${q.text}</div>`;
        if(q.image){
          const im=document.createElement('img'); im.src=q.image; im.className='img-thumb mb-2'; box.appendChild(im);
        }
        const grid=document.createElement('div'); grid.className='grid grid-cols-1 md:grid-cols-2 gap-2';
        q.choices.forEach((c,ci)=>{
          const label=document.createElement('label');
          label.className='flex items-center gap-2 p-2 rounded-lg bg-white/5 hover:bg-white/10 cursor-pointer';
          label.innerHTML=`<input type="radio" name="q${qi}" value="${ci}"> <span>${c}</span>`;
          grid.appendChild(label);
        });
        box.appendChild(grid); wrap.appendChild(box);
      });
      $('#takeResult').textContent='';
      $('#analysisBox').classList.add('hidden'); $('#analysisBox').innerHTML='';
      $('#takeModal').classList.remove('hidden'); $('#takeModal').classList.add('flex');
    }
    function closeTake(){ $('#takeModal').classList.add('hidden'); $('#takeModal').classList.remove('flex'); takeCurrent=null; }
    window.closeTake=closeTake;

    // ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ + Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª
    function showAnalysisAndInquiries(test, perQCorrect){
      const box = $('#analysisBox'); box.classList.remove('hidden');

      // ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£Ø¶Ø¹Ù Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ
      const myResults = solvedByUser(currentUser.id);
      const cats = ['placement','verbal','quant'];
      const rateByCat = {};
      cats.forEach(c=>{
        const arr = myResults.filter(r=>r.category===c);
        const hit = arr.reduce((a,r)=>a+r.score,0);
        const tot = arr.reduce((a,r)=>a+r.total,0);
        rateByCat[c] = tot? (hit/tot): null;
      });
      const weakest = Object.entries(rateByCat).filter(([c,v])=>v!==null).sort((a,b)=>a[1]-b[1])[0]?.[0] || test.category;

      // Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø©
      const wrongIdx = perQCorrect.map((v,i)=>v?null:i).filter(v=>v!==null);
      box.innerHTML = `
        <div class="text-sm">
          <div class="font-bold mb-1">ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ Ù„Ù„Ù†ØªÙŠØ¬Ø©</div>
          <div class="text-slate-300">Ø£Ø¶Ø¹Ù Ù‚Ø³Ù… Ù„Ø¯ÙŠÙƒ: <span class="text-amber-300">${labelCat(weakest)}</span></div>
          ${wrongIdx.length? `<div class="mt-2">Ø£Ø³Ø¦Ù„Ø© ØªØ­ØªØ§Ø¬ Ù…Ø±Ø§Ø¬Ø¹Ø©: ${wrongIdx.map(i=>'#'+(i+1)).join('ØŒ ')}</div>` : `<div class="mt-2 text-emerald-300">Ù…Ù…ØªØ§Ø²! Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø®Ø§Ø·Ø¦Ø© ğŸ‰</div>`}
        </div>
        ${wrongIdx.length? `<div class="mt-3">
          <div class="text-sm font-bold mb-1">Ø§Ø³ØªÙØ³Ø§Ø± Ø¹Ù† Ø³Ø¤Ø§Ù„:</div>
          <div class="flex gap-2 items-center">
            <select id="inqIndex" class="input w-32">
              ${wrongIdx.map(i=>`<option value="${i}">Ø³Ø¤Ø§Ù„ ${i+1}</option>`).join('')}
            </select>
            <input id="inqText" class="input flex-1" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³ØªÙØ³Ø§Ø±Ùƒ Ù„Ù„Ù…Ø¹Ù„Ù…">
            <button id="sendInquiry" class="btn pill px-3 py-2 bg-white/10 hover:bg-white/20">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø¹Ù„Ù…</button>
          </div>
          <div class="text-xs text-slate-400 mt-1">Ø³ÙŠØµÙ„ Ø§Ø³ØªÙØ³Ø§Ø±Ùƒ Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (Ø¥Ù† ÙˆÙØ¬Ø¯)ØŒ ÙˆØ³ØªØ±Ù‰ Ø§Ù„Ø±Ø¯ÙˆØ¯ ÙÙŠ ØµÙØ­Ø© â€œØ§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙ… Ø­Ù„Ù‡Ø§â€.</div>
        </div>` : '' }
      `;
      const btn = $('#sendInquiry');
      if(btn){
        btn.onclick = ()=>{
          const qIndex = parseInt($('#inqIndex').value);
          const text = ($('#inqText').value||'').trim();
          if(!text) return toast('Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±','warn');
          const q = {id:crypto.randomUUID(), fromUserId:currentUser.id, toTeacherId: test.teacherId || null, testId:test.id, qIndex, text, replies:[], at:Date.now()};
          const list = DB.getInquiries(); list.push(q); DB.setInquiries(list);
          toast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³ØªÙØ³Ø§Ø±'); $('#inqText').value=''; 
        };
      }
    }

    document.getElementById('submitAnswers').onclick=()=>{
      if(!takeCurrent) return;
      let correct=0; const perQ=[];
      takeCurrent.questions.forEach((q,qi)=>{
        const sel=document.querySelector(`input[name="q${qi}"]:checked`);
        const ok = (sel && parseInt(sel.value)===q.correctIndex)?1:0; perQ.push(ok);
        if(ok) correct++;
      });
      $('#takeResult').textContent=`Ù†ØªÙŠØ¬ØªÙƒ: ${correct} / ${takeCurrent.questions.length}`;
      const res=DB.getResults();
      if(!isSolved(currentUser.id, takeCurrent.id)){
        res.push({
          id:crypto.randomUUID(), userId:currentUser.id, testId:takeCurrent.id,
          score:correct, total:takeCurrent.questions.length, at:Date.now(),
          perQ: perQ, category: takeCurrent.category
        });
        DB.setResults(res);
      }
      // Ù†Ù‚Ø§Ø· + Ø´Ø§Ø±Ø§Øª + streak ØªØ­Ø¯ÙŠØ« Ù†Ø´Ø§Ø· Ø§Ù„ÙŠÙˆÙ…
      recalcPoints(currentUser.id); updatePointsUI(); updateBadgesAndBars();
      const users=DB.getUsers(); const idx=users.findIndex(u=>u.id===currentUser.id);
      users[idx].lastActive = todayKey(); DB.setUsers(users); currentUser=users[idx]; refreshStreakUI();

      // ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ + Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª
      showAnalysisAndInquiries(takeCurrent, perQ);

      setTimeout(()=>{ /* Ù„Ø§ Ù†ØºÙ„Ù‚ ÙÙˆØ±Ù‹Ø§ Ø­ØªÙ‰ ÙŠØ±Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„ */ }, 0);
    };

    // ===== Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø¹Ù„Ù… / Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ + ØªØµØ¯ÙŠØ± CSV =====
    let lastTeacherTestId = null, lastAdminTestId = null;

    function exportCSV(rows, filename){
      const csv = rows.map(r=>r.map(v=>String(v).replace(/"/g,'""')).map(v=>`"${v}"`).join(',')).join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
      a.download = filename || 'results.csv'; a.click();
    }

    function openTeacherResults(testId){
      lastTeacherTestId = testId;
      $('#teacherDash').classList.add('hidden'); $('#teacherResults').classList.remove('hidden');
      const results = DB.getResults().filter(r=>r.testId===testId);
      const users = DB.getUsers();
      const table = $('#teacherResultsTable'); table.innerHTML='';
      if(results.length===0){ table.innerHTML='<div class="text-slate-400">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ø­Ù„ÙˆØ§ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±.</div>'; }
      results.forEach(r=>{
        const u = users.find(x=>x.id===r.userId);
        const row = document.createElement('div');
        row.className='p-3 rounded-lg bg-white/5 border border-white/10 flex items-center justify-between';
        row.innerHTML = `<div>${u?u.name:'Ø·Ø§Ù„Ø¨'} â€” ${u?.grade||''} ${u?.class?('â€¢ ÙØµÙ„ '+u.class):''}</div>
                         <div class="text-amber-200">${r.score}/${r.total}</div>`;
        table.appendChild(row);
      });
      $('#backToTeacher').onclick = ()=>{ $('#teacherResults').classList.add('hidden'); $('#teacherDash').classList.remove('hidden'); };
      $('#exportTeacherCSV').onclick = ()=>{
        const rows = [['Ø§Ù„Ø·Ø§Ù„Ø¨','Ø§Ù„ØµÙ','Ø§Ù„ÙØµÙ„','Ø§Ù„Ø¯Ø±Ø¬Ø©','Ù…Ù†']];
        results.forEach(r=>{
          const u = users.find(x=>x.id===r.userId)||{};
          rows.push([u.name||'Ø·Ø§Ù„Ø¨', u.grade||'', u.class||'', r.score, r.total]);
        });
        exportCSV(rows, 'teacher_results.csv');
      };
    }

    function openAdminResults(testId){
      lastAdminTestId = testId;
      $('#adminDash').classList.add('hidden'); $('#adminResults').classList.remove('hidden');
      renderAdminResults('');
      $('#backToAdmin').onclick = ()=>{ $('#adminResults').classList.add('hidden'); $('#adminDash').classList.remove('hidden'); };
      $('#exportAdminCSV').onclick = ()=>{
        const {rows} = buildAdminRows('');
        exportCSV(rows, 'admin_results.csv');
      };
      $('#adminSearchStudent').oninput = (e)=> renderAdminResults(e.target.value.trim());
    }
    function buildAdminRows(q){
      const results = DB.getResults().filter(r=>r.testId===lastAdminTestId);
      const users = DB.getUsers();
      const tests = DB.getTests();
      const t = tests.find(t=>t.id===lastAdminTestId);
      const filtered = results.filter(r=>{
        const u = users.find(x=>x.id===r.userId)||{};
        return !q || (u.name||'').includes(q);
      });
      const rows = [['Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±','Ø§Ù„Ù‚Ø³Ù…','Ø§Ù„Ø·Ø§Ù„Ø¨','Ø§Ù„ØµÙ','Ø§Ù„ÙØµÙ„','Ø§Ù„Ø¯Ø±Ø¬Ø©','Ù…Ù†','ØªØ§Ø±ÙŠØ®']];
      filtered.forEach(r=>{
        const u = users.find(x=>x.id===r.userId)||{};
        rows.push([t?t.title:'Ø§Ø®ØªØ¨Ø§Ø±', labelCat(r.category), u.name||'Ø·Ø§Ù„Ø¨', u.grade||'', u.class||'', r.score, r.total, new Date(r.at).toLocaleString()]);
      });
      return {filtered, users, t, rows};
    }
    function renderAdminResults(q){
      const table = $('#adminResultsTable'); table.innerHTML='';
      const {filtered, users} = buildAdminRows(q);
      if(filtered.length===0){ table.innerHTML='<div class="text-slate-400">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.</div>'; return; }
      filtered.forEach(r=>{
        const u = users.find(x=>x.id===r.userId)||{};
        const row = document.createElement('div');
        row.className = 'p-3 rounded-lg bg-white/5 border border-white/10 flex items-center justify-between';
        row.innerHTML = `<div class="text-sm"><span class="font-bold">${u.name||'Ø·Ø§Ù„Ø¨'}</span> â€” ${u.grade||''} ${u.class?('â€¢ ÙØµÙ„ '+u.class):''}</div>
                         <div class="text-amber-200">${r.score}/${r.total}</div>`;
        table.appendChild(row);
      });
    }

    // ===== Messages (Ø·Ø§Ù„Ø¨ -> Ù…Ø³Ø¤ÙˆÙ„ ÙÙ‚Ø· ÙƒÙ…Ø§ ÙÙŠ Ù†Ø³Ø®ØªÙƒ) =====
    document.getElementById('sendMsgToAdmin').onclick = ()=>{
      const content=$('#msgToAdmin').value.trim(); if(!content) return toast('Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø©','warn');
      const msgs=DB.getMsgs(); msgs.push({id:crypto.randomUUID(), from:currentUser.id, to:'admin', content, replies:[], createdAt:Date.now()});
      DB.setMsgs(msgs); $('#msgToAdmin').value=''; toast('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„'); loadStudentReplies();
    };

    // ===== Init =====
    function updateUIAfterLogin(){
      $('#btnLogout').classList.remove('hidden');
      $('#whoami').classList.remove('hidden');
      $('#pointsBadge').classList.remove('hidden');
      $('#streakBadge').classList.remove('hidden');
      $('#whoami').textContent=`${roles[currentUser.role]} â€” ${currentUser.name}`;
    }
    if(currentUser){
      $('#authSection').classList.add('hidden');
      $('#appSection').classList.remove('hidden');
      updateUIAfterLogin();
      route();
    }
    rotateMotivation();

  </script>
</body>
</html>
